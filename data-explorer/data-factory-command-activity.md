---
title: Использование команд управления обозреватель данных Azure в фабрике данных Azure
description: В этом разделе Использование команд управления обозреватель данных Azure в фабрике данных Azure
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: tzgitlin
ms.service: data-explorer
ms.topic: how-to
ms.date: 09/15/2019
ms.openlocfilehash: af351530b8622785f76c6165aede056073aff67f
ms.sourcegitcommit: f354accde64317b731f21e558c52427ba1dd4830
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88873395"
---
# <a name="use-azure-data-factory-command-activity-to-run-azure-data-explorer-control-commands"></a>Использование действия команды фабрики данных Azure для запуска команд управления обозреватель данных Azure

[Фабрика данных Azure](/azure/data-factory/) (ADF) — это облачная служба интеграции данных, которая позволяет выполнять сочетание действий с данными. Используйте ADF для создания управляемых данными рабочих процессов для оркестрации и автоматизации перемещения и преобразования данных. Действие **команды azure обозреватель данных** в фабрике данных Azure позволяет выполнять [команды управления обозреватель данных Azure](kusto/concepts/index.md#control-commands) в рабочем процессе ADF. В этой статье объясняется, как создать конвейер с действием поиска и действием ForEach, содержащим действие команды Azure обозреватель данных.

## <a name="prerequisites"></a>Предварительные требования

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.
* [Кластер и база данных Azure обозреватель данных](create-cluster-database-portal.md)
* Источник данных.
* [Фабрика данных](data-factory-load-data.md#create-a-data-factory)

## <a name="create-a-new-pipeline"></a>Создание конвейера

1. Выберите инструмент **Author** карандаш. 
1. Создайте новый конвейер, выбрав **+** и выбрав в раскрывающемся списке пункт **конвейер** .

   ![Создание нового конвейера](media/data-factory-command-activity/create-pipeline.png)

## <a name="create-a-lookup-activity"></a>Создание действия уточняющего запроса

[Действие поиска](/azure/data-factory/control-flow-lookup-activity) может получить набор данных из любых источников данных, поддерживаемых фабрикой данных Azure. Выходные данные действия поиска можно использовать в операторе ForEach или другом действии.

1. В области **действия** в разделе **Общие**выберите действие **Поиск** . Перетащите его на основной холст справа.
 
    ![Выбор действия уточняющего запроса](media/data-factory-command-activity/select-activity.png)

1. Теперь холст содержит созданное вами действие поиска. Используйте вкладки под холстом, чтобы изменить соответствующие параметры. В **общем**случае переименуйте действие. 

    ![изменить действие уточняющего запроса](media/data-factory-command-activity/edit-lookup-activity.png)

    > [!TIP]
    > Щелкните пустую область холста, чтобы просмотреть свойства конвейера. Используйте вкладку **Общие** для переименования конвейера. Наш конвейер называется *Pipeline-4-документация*.

### <a name="create-an-azure-data-explorer-dataset-in-lookup-activity"></a>Создание набора данных обозреватель данных Azure в действии поиска

1. В окне **Параметры**выберите предварительно созданный **исходный набор данных**обозреватель данных Azure или нажмите кнопку **+ создать** , чтобы создать новый набор данных.
 
    ![Добавление набора данных в параметры поиска](media/data-factory-command-activity/lookup-settings.png)

1. Выберите набор данных **Azure обозреватель данных (Kusto)** в окне " **новый набор данных** ". Нажмите кнопку **продолжить** , чтобы добавить новый набор данных.

   ![Выбор нового набора данных](media/data-factory-command-activity/select-new-dataset.png) 

1. Новые параметры набора данных обозреватель данных Azure отображаются в окне **Параметры**. Чтобы обновить параметры, нажмите кнопку **изменить**.

    ![параметры подстановки с помощью набора данных Azure обозреватель данных](media/data-factory-command-activity/lookup-settings-with-adx-dataset.png)

1. На главном холсте откроется вкладка **азуредатаексплорертабле** New (создать). 
    * Выберите **Общие** и измените имя набора данных. 
    * Выберите **Подключение** , чтобы изменить свойства набора данных. 
    * Выберите **связанную службу** из раскрывающегося списка или нажмите кнопку **+ создать** , чтобы создать связанную службу.

    ![Изменение свойств набора данных Azure обозреватель данных](media/data-factory-command-activity/adx-dataset-properties-edit-connections.png)

1. При создании новой связанной службы открывается страница **Новая связанная служба (Azure обозреватель данных)** :

    ![Новая связанная служба ADX](media/data-factory-command-activity/adx-new-linked-service.png)

   * Выберите **имя** для связанной службы Azure обозреватель данных. При необходимости добавьте **Описание** .
   * В окне **подключение через среду выполнения интеграции**измените текущие параметры, если это необходимо. 
   * В окне **метод выбора учетной записи** выберите кластер одним из двух способов: 
        * Выберите переключатель **из подписки Azure** и выберите свою учетную запись **подписки Azure** . Затем выберите свой **кластер**. Обратите внимание, что в раскрывающемся списке будут перечислены только те кластеры, которые принадлежат пользователю.
        * Вместо этого установите переключатель **введите вручную** и введите **конечную точку** (URL-адрес кластера).
    * Укажите **клиент**.
    * Введите **идентификатор субъекта-службы**. ИДЕНТИФИКАТОР субъекта должен иметь соответствующие разрешения в соответствии с уровнем разрешений, требуемым для используемой команды.
    * Нажмите кнопку **ключ субъекта-службы** и введите **ключ субъекта-службы**.
    * Выберите свою **базу данных** в раскрывающемся меню. Кроме того, можно установить флажок **изменить** и ввести имя базы данных.
    * Выберите **проверить подключение** , чтобы проверить созданное соединение связанной службы. Если вы можете подключиться к программе установки, появится зеленая галочка **успешное подключение** .
    * Нажмите кнопку **Готово** , чтобы завершить создание связанной службы.

1. После настройки связанной службы в **азуредатаексплорертабле**  >  **Connection**добавьте имя **таблицы** . Выберите **Предварительный просмотр данных**, чтобы убедиться, что данные представлены должным образом.

   Теперь набор данных готов, и вы можете продолжить редактирование конвейера.

### <a name="add-a-query-to-your-lookup-activity"></a>Добавление запроса в действие поиска

1. В **конвейере 4 —**  >  **Параметры** документов добавьте запрос в текстовом поле **запроса** , например:

    ```kusto
    ClusterQueries
    | where Database !in ("KustoMonitoringPersistentDatabase", "$systemdb")
    | summarize count() by Database
    ```

1. При необходимости измените **время ожидания запроса** , а также свойства **без усечения** и **только для первой строки** . В этом потоке мы храним **время ожидания запроса** по умолчанию и снимите флажки. 

    ![Окончательные параметры действия поиска](media/data-factory-command-activity/lookup-activity-final-settings.png)

## <a name="create-a-for-each-activity"></a>Создание действия for-each 

Действие [for-each](/azure/data-factory/control-flow-for-each-activity) используется для прохода по коллекции и выполнения указанных действий в цикле. 

1. Теперь вы добавляете действие for-each в конвейер. Это действие обработает данные, возвращенные действием поиска. 
    * В области **действия** в разделе **Итерация & условия**выберите действие **foreach** и перетащите его на холст.
    * Нарисуйте линию между выходными данными действия уточняющего запроса и входными данными для действия ForEach на холсте, чтобы соединить их.

        ![Действие ForEach](media/data-factory-command-activity/for-each-activity.png)

1. Выберите действие ForEach на холсте. На вкладке **Параметры** ниже:
    * Установите флажок **последовательный** для последовательной обработки результатов поиска или оставьте флажок снятым, чтобы создать параллельную обработку.
    * Задать **число пакетов**.
    * В **элементах**укажите следующую ссылку на выходное значение: * @activity (' Lookup1 '). Output. Value*

       ![Настройки действия ForEach](media/data-factory-command-activity/for-each-activity-settings.png)

## <a name="create-an-azure-data-explorer-command-activity-within-the-foreach-activity"></a>Создание действия команды Azure обозреватель данных в рамках действия ForEach

1. Дважды щелкните действие ForEach на холсте, чтобы открыть его на новом холсте, чтобы указать действия в ForEach.
1. В области **действия** в разделе **Azure обозреватель данных**выберите действие **команды обозреватель данных Azure** и перетащите его на холст.

    ![Действие команды Azure обозреватель данных](media/data-factory-command-activity/adx-command-activity.png)

1. На вкладке **Подключение** выберите ранее созданную связанную службу.

    ![Вкладка подключения действия команды обозревателя данных Azure](media/data-factory-command-activity/adx-command-activity-connection-tab.png)

1. На вкладке **команда** введите следующую команду:

    ```kusto
    .export
    async compressed
    into csv h"http://<storageName>.blob.core.windows.net/data/ClusterQueries;<storageKey>" with (
    sizeLimit=100000,
    namePrefix=export
    )
    <| ClusterQueries | where Database == "@{item().Database}"
    ```

    **Команда** указывает Azure обозреватель данных экспортировать результаты заданного запроса в хранилище BLOB-объектов в сжатом формате. Он выполняется асинхронно (с помощью модификатора async).
    Запрос обращается к столбцу базы данных каждой строки в результатах действия поиска. **Время ожидания команды** может остаться без изменений.

    ![действие команды](media/data-factory-command-activity/command.png)   

    > [!NOTE]
    > Действие команды имеет следующие ограничения:
    > * Ограничение размера: 1 МБ размер ответа
    > * Ограничение по времени: 20 минут (по умолчанию), 1 час (максимум).
    > * При необходимости можно добавить запрос к результату с помощью [админсенкуери](kusto/management/index.md#combining-queries-and-control-commands), чтобы сократить результирующий размер и время.

1. Теперь конвейер готов. Вы можете вернуться к основному представлению конвейера, щелкнув имя конвейера.

    ![Конвейер команд Azure обозреватель данных](media/data-factory-command-activity/adx-command-pipeline.png)

1. Выберите **Отладка** перед публикацией конвейера. Ход выполнения конвейера можно отслеживать на вкладке **выходные данные** .

    ![выходные данные действия команды обозревателя данных Azure](media/data-factory-command-activity/command-activity-output.png)

1. Можно **опубликовать все** , а затем **добавить триггер** для запуска конвейера. 

## <a name="control-command-outputs"></a>Управление выходными командами команды

Ниже описана структура выходных данных действия команды. Эти выходные данные могут использоваться следующим действием в конвейере.

### <a name="returned-value-of-a-non-async-control-command"></a>Возвращаемое значение команды элемента управления, не являющейся асинхронной

В команде элемента управления, не являющейся асинхронной, структура возвращаемого значения похожа на структуру результата действия поиска. `count`Поле показывает число возвращенных записей. Поле фиксированного массива `value` содержит список записей. 

```json
{ 
    "count": "2", 
    "value": [ 
        { 
            "ExtentId": "1b9977fe-e6cf-4cda-84f3-4a7c61f28ecd", 
            "ExtentSize": 1214.0, 
            "CompressedSize": 520.0 
        }, 
        { 
            "ExtentId": "b897f5a3-62b0-441d-95ca-bf7a88952974", 
            "ExtentSize": 1114.0, 
            "CompressedSize": 504.0 
        } 
    ] 
} 
```
 
### <a name="returned-value-of-an-async-control-command"></a>Возвращаемое значение команды асинхронного управления

В команде асинхронного управления действие опрашивает таблицу операций в фоновом режиме до тех пор, пока не завершится асинхронная операция или не истечет время ожидания. Таким образом, возвращаемое значение будет содержать результат `.show operations OperationId` для данного свойства с **OperationId** идентификатором. Проверьте значения свойств **State** и **Status** , чтобы проверить успешность выполнения операции.

```json
{ 
    "count": "1", 
    "value": [ 
        { 
            "OperationId": "910deeae-dd79-44a4-a3a2-087a90d4bb42", 
            "Operation": "TableSetOrAppend", 
            "NodeId": "", 
            "StartedOn": "2019-06-23T10:12:44.0371419Z", 
            "LastUpdatedOn": "2019-06-23T10:12:46.7871468Z", 
            "Duration": "00:00:02.7500049", 
            "State": "Completed", 
            "Status": "", 
            "RootActivityId": "f7c5aaaf-197b-4593-8ba0-e864c94c3c6f", 
            "ShouldRetry": false, 
            "Database": "MyDatabase", 
            "Principal": "<some principal id>", 
            "User": "<some User id>" 
        } 
    ] 
}
``` 

## <a name="next-steps"></a>Дальнейшие шаги

* Узнайте, как [Копировать данные в azure обозреватель данных с помощью фабрики данных Azure](data-factory-load-data.md).
* Узнайте, как использовать [шаблон фабрики данных Azure для копирования из базы данных в Azure обозреватель данных](data-factory-template.md).
