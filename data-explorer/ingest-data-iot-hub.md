---
title: Прием данных из центра Интернета вещей в Azure обозреватель данных
description: Из этой статьи вы узнаете, как принимать (загружать) данные в Azure обозреватель данных из центра Интернета вещей.
author: orspod
ms.author: orspodek
ms.reviewer: tzgitlin
ms.service: data-explorer
ms.topic: conceptual
ms.date: 01/08/2020
ms.openlocfilehash: 36c724a001bb4438757316a456fbf85b55691c09
ms.sourcegitcommit: f7f3ecef858c1e8d132fc10d1e240dcd209163bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2020
ms.locfileid: "88201580"
---
# <a name="ingest-data-from-iot-hub-into-azure-data-explorer"></a>Прием данных из центра Интернета вещей в Azure обозреватель данных 

> [!div class="op_single_selector"]
> * [Портал](ingest-data-iot-hub.md)
> * [C#](data-connection-iot-hub-csharp.md)
> * [Python](data-connection-iot-hub-python.md)
> * [Шаблон Azure Resource Manager](data-connection-iot-hub-resource-manager.md)

[!INCLUDE [data-connector-intro](includes/data-connector-intro.md)]

В этой статье показано, как передавать данные в Azure обозреватель данных из центра Интернета вещей, платформы потоковой передачи больших данных и службы приема Интернета вещей.

## <a name="prerequisites"></a>Предварительные требования

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.
* Создайте [тестовый кластер и базу данных](create-cluster-database-portal.md) с именем базы данных *TestDB*.
* [Пример приложения](https://github.com/Azure-Samples/azure-iot-samples-csharp) и документация по моделированию устройства.
* [Visual Studio 2019](https://visualstudio.microsoft.com/vs/) для запуска примера приложения.

## <a name="create-an-iot-hub"></a>Создание центра Интернета вещей

[!INCLUDE [iot-hub-include-create-hub](includes/iot-hub-include-create-hub.md)]

## <a name="register-a-device-to-the-iot-hub"></a>Регистрация устройства в центре Интернета вещей

[!INCLUDE [iot-hub-get-started-create-device-identity](includes/iot-hub-get-started-create-device-identity.md)]

## <a name="create-a-target-table-in-azure-data-explorer"></a>Создание целевой таблицы в обозревателе данных Azure

Теперь вы создадите таблицу в обозреватель данных Azure, к которой центры Интернета вещей будут отсылать данные. Создайте таблицу в кластере и базе данных, подготовленные в [**предварительных требованиях**](#prerequisites).

1. На портале Azure перейдите в свой кластер и выберите **Запрос**.

    ![Запрос ADX на портале](media/ingest-data-iot-hub/adx-initiate-query.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить**, чтобы создать таблицу (TestTable), которая будет принимать входящие данные.

    ```Kusto
    .create table TestTable (temperature: real, humidity: real)
    ```
    
    ![Выполнение создания запроса](media/ingest-data-iot-hub/run-create-query.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить** для сопоставления входящих данных JSON с именами столбцов и типами данных таблицы (TestTable).

    ```Kusto
    .create table TestTable ingestion json mapping 'TestMapping' '[{"column":"humidity","path":"$.humidity","datatype":"real"},{"column":"temperature","path":"$.temperature","datatype":"real"}]'
    ```

## <a name="connect-azure-data-explorer-table-to-iot-hub"></a>Подключение таблицы обозреватель данных Azure к центру Интернета вещей

Теперь вы подключаетесь к центру Интернета вещей из обозреватель данных Azure. После завершения этого подключения данные, перенаправляемые в потоки центра Интернета вещей в [созданную вами целевую таблицу](#create-a-target-table-in-azure-data-explorer).

1. На панели инструментов выберите **уведомления** , чтобы убедиться, что развертывание центра Интернета вещей успешно завершено.

1. В созданном кластере **выберите базы данных и** выберите базу данных, созданную **TestDB**.
    
    ![Выбор тестовой базы данных](media/ingest-data-iot-hub/select-database.png)

1. Выберите **Прием данных** и **Добавить подключение к данным**. Заполните форму, указав следующую информацию. Когда все будет готово, выберите **создать** .

    ![Подключение центра Интернета вещей](media/ingest-data-iot-hub/iot-hub-connection.png)

    **Источник данных**:

    **Параметр** | **Описание поля**
    |---|---|
    | Имя подключения к данным | Имя подключения, которое необходимо создать в Azure обозреватель данных
    | Центр Интернета вещей | Имя Центра Интернета вещей |
    | Политика общего доступа | Имя политики общего доступа. Должны иметь разрешения на чтение |
    | Группа потребителей |  Группа потребителей, определенная в встроенной конечной точке центра Интернета вещей |
    | Свойства системы событий | [Свойства системы событий центра Интернета вещей](/azure/iot-hub/iot-hub-devguide-messages-construct#system-properties-of-d2c-iot-hub-messages). При добавлении системных свойств [Создайте](kusto/management/create-table-command.md) или [Обновите](kusto/management/alter-table-command.md) схему таблицы и [сопоставление](kusto/management/mappings.md) , чтобы включить выбранные свойства. | | | 

    > [!NOTE]
    > В случае [отработки отказа вручную](/azure/iot-hub/iot-hub-ha-dr#manual-failover)необходимо создать подключение к данным.

    **Целевая таблица**:

    Существуют два варианта маршрутизации принятых данных: *статическая* и *динамическая*. 
    В этой статье используется статическая маршрутизация, для которой нужно указать имя таблицы, формат данных и сопоставление. Поэтому не устанавливайте флажок **Мои данные содержат сведения о маршрутизации**.

     **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Таблица | *TestTable* | Таблица, созданная в **TestDB**. |
    | Формат данных | *JSON* | Поддерживаются форматы Avro, CSV, JSON, многострочные JSON, ORC, PARQUET, ПСВ, СКСВ, СОХСВ, TSV, TXT, ТСВЕ, АПАЧЕАВРО и W3CLOG.|
    | Сопоставление столбцов | *TestMapping* | [Сопоставление](kusto/management/mappings.md) , созданное в **TestDB**, которое сопоставляет входящие данные JSON с именами столбцов и типами данных **TestDB**. Требуется для JSON, многострочного JSON и AVRO, а для других форматов — необязательно.|
    | | |

    > [!NOTE]
    > * Выберите **My data includes routing info** (Мои данные содержат сведения о маршрутизации) для использования динамической маршрутизации, при которой данные содержат необходимые сведения о маршрутизации, как показано в комментариях [примера приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest). Если заданы свойства статической и динамической маршрутизации, то свойство динамической маршрутизации переопределяет свойство статической. 
    > * Принимаются только события, помещенные в очередь после создания подключения к данным.

[!INCLUDE [data-explorer-container-system-properties](includes/data-explorer-container-system-properties.md)]

## <a name="generate-sample-data-for-testing"></a>Создание демонстрационных данных для тестирования

Приложение имитированного устройства подключается к конечной точке конкретного устройства Центра Интернета вещей и отправляет имитированную телеметрию температуры и влажности.

1. Скачайте пример проекта C# по ссылке https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip и извлеките ZIP-архив.

1. В окне терминала на локальном компьютере перейдите в корневую папку примера проекта C#. Затем перейдите в папку **iot-hub\Quickstarts\simulated-device**.

1. Откройте файл **SimulatedDevice.cs** в любом текстовом редакторе.

    Замените значение `s_connectionString` переменной строкой подключения устройства из раздела [Регистрация устройства в центре Интернета вещей](#register-a-device-to-the-iot-hub). Сохраните изменения в файле **SimulatedDevice.cs**.

1. Установите необходимые пакеты приложения имитированного устройства, выполнив в окне терминала на локальном компьютере следующие команды:

    ```cmd/sh
    dotnet restore
    ```

1. Создайте и запустите приложение имитированного устройства, выполнив в окне терминала на локальном компьютере следующие команды:

    ```cmd/sh
    dotnet run
    ```

    На следующем снимке экрана показан пример выходных данных, когда приложение имитированного устройства отправляет данные телеметрии в Центр Интернета вещей:

    ![Запуск виртуального устройства](media/ingest-data-iot-hub/simulated-device.png)

## <a name="review-the-data-flow"></a>Просмотр потока данных

После создания данных приложение теперь может видеть поток данных из центра Интернета вещей в таблицу в кластере.

1. В портал Azure в центре Интернета вещей вы увидите пиковое действие во время работы приложения.

    ![Метрики Центра Интернета вещей](media/ingest-data-iot-hub/iot-hub-metrics.png)

1. Чтобы проверить, сколько сообщений поступило в базу данных к этому моменту, выполните следующий запрос в тестовой базе данных.

    ```Kusto
    TestTable
    | count
    ```

1. Чтобы увидеть содержимое сообщений, выполните следующий запрос:

    ```Kusto
    TestTable
    ```

    Результирующий набор:
    
    ![Отображение результатов полученных данных](media/ingest-data-iot-hub/show-ingested-data.png)

    > [!NOTE]
    > * В Azure Data Explorer настроена политика агрегирования (пакетной обработки) для приема данных, предназначенных для оптимизации процесса. По умолчанию для политики настроено 5 минут или 500 МБ данных, поэтому может возникнуть задержка. Просмотрите [политику пакетной обработки](kusto/management/batchingpolicy.md) для параметров статической обработки. 
    > * Настройте таблицу для поддержки потоковой передачи и отмените задержку в времени отклика. См. раздел [Политика потоковой передачи](kusto/management/streamingingestionpolicy.md). 

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не планируете использовать центр Интернета вещей еще раз, очистите группу ресурсов, чтобы избежать появления постоянных затрат.

1. На портале Azure выберите **Группа ресурсов** слева, а затем выберите созданную группу ресурсов.  

    Если левое меню свернуто, нажмите ![кнопку "Развернуть",](media/ingest-data-event-hub/expand.png) чтобы развернуть его.

   ![Выбор удаляемой группы ресурсов](media/ingest-data-iot-hub/delete-resources-select.png)

1. В разделе **test-resource-group** выберите **Удалить группу ресурсов**.

2. В новом окне введите имя группы ресурсов, чтобы удалить ее, а затем выберите **Удалить**.

## <a name="next-steps"></a>Дальнейшие шаги

* [Запрос данных в обозреватель данных Azure](web-query-data.md)
