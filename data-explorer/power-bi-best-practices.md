---
title: Рекомендации по использованию Power BI для запроса и визуализации данных обозреватель данных Azure
description: В этой статье вы узнаете о рекомендациях по использованию Power BI для запроса и визуализации данных обозреватель данных Azure.
author: orspod
ms.author: orspodek
ms.reviewer: gabil
ms.service: data-explorer
ms.topic: how-to
ms.date: 09/26/2019
ms.openlocfilehash: 442185ed0afd977c103d0b571472c0f5e742908c
ms.sourcegitcommit: 455d902bad0aae3e3d72269798c754f51442270e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2020
ms.locfileid: "93349483"
---
# <a name="best-practices-for-using-power-bi-to-query-and-visualize-azure-data-explorer-data"></a>Рекомендации по использованию Power BI для запроса и визуализации данных обозреватель данных Azure

Обозреватель данных Azure — это быстрая и высокомасштабируемая служба для изучения данных журналов и телеметрии. [Power BI](/power-bi/) — это решение бизнес-аналитики, которое позволяет визуализировать данные и совместно использовать результаты в Организации. Обозреватель данных Azure предоставляет три варианта подключения к данным в Power BI. Используйте [Встроенный соединитель](power-bi-connector.md), [импортируйте запрос из Azure обозреватель данных в Power BI](power-bi-imported-query.md)или используйте [SQL-запрос](power-bi-sql-query.md). В этой статье содержатся советы по созданию запросов и визуализации данных Azure обозреватель данных с помощью Power BI. 

## <a name="best-practices-for-using-power-bi"></a>Рекомендации по использованию Power BI

При работе с терабайтами новых необработанных данных следуйте приведенным ниже рекомендациям по обеспечению привязки и обновления Power BI панелей мониторинга и отчетов.

* **Источник** перемещения. Перенесите только те данные, которые необходимы для Power BI отчетов. Для углубленного интерактивного анализа используйте [веб-интерфейс Azure обозреватель данных](web-query-data.md) , оптимизированный для специального исследования с помощью языка запросов Kusto.

* **Составная** модель. Используйте [составную модель](/power-bi/desktop-composite-models) , чтобы объединить агрегированные данные для панелей мониторинга верхнего уровня с отфильтрованными операционными необработанными данными. Можно четко определить, когда следует использовать необработанные данные и когда следует использовать агрегированное представление. 

* **Режим импорта и режим DirectQuery** — используйте режим **импорта** для взаимодействия с меньшими наборами данных. Режим **DirectQuery** используется для больших, часто обновляемых наборов данных. Например, создайте таблицы измерений с помощью режима **импорта** , так как они небольшие и не меняются часто. Установите интервал обновления в соответствии с ожидаемой частотой обновлений данных. Создание таблиц фактов с помощью режима **DirectQuery** , так как эти таблицы велики и содержат необработанные данные. Используйте эти таблицы для представления отфильтрованных данных с помощью [детализации](/power-bi/desktop-drillthrough)Power BI.

* **Параллелизм** . Azure обозреватель данных — это линейная масштабируемая платформа данных, поэтому вы можете повысить производительность отрисовки панели мониторинга, увеличив параллелизм сквозного потока следующим образом:

  * Увеличьте число [одновременных подключений в DirectQuery в Power BI](/power-bi/desktop-directquery-about#maximum-number-of-connections-option-for-directquery).

  * Используйте [слабую согласованность для улучшения параллелизма](kusto/concepts/queryconsistency.md). Это может повлиять на актуальность данных.

* **Действующие срезы** — используйте [срезы синхронизации](/power-bi/visuals/power-bi-visualization-slicers#sync-and-use-slicers-on-other-pages) , чтобы предотвратить загрузку данных отчетами перед тем, как будете готовы. После структурирования набора данных, размещения всех визуальных элементов и пометки всех срезов можно выбрать срез синхронизации для загрузки только необходимых данных.

* **Использование фильтров** . используйте столько Power BI фильтров, сколько возможно, чтобы сосредоточиться на поиске обозреватель данных Azure по соответствующим сегментам данных.

* **Эффективные визуальные элементы** — выберите наиболее производительные визуальные элементы для данных.


## <a name="tips-for-using-the-azure-data-explorer-connector-for-power-bi-to-query-data"></a>Советы по использованию соединителя Azure обозреватель данных для Power BI запроса данных

В следующем разделе приведены советы и рекомендации по использованию языка запросов Kusto с Power BI. Использование [соединителя Azure обозреватель данных для](power-bi-connector.md) визуализации данных Power BI

### <a name="complex-queries-in-power-bi"></a>Сложные запросы в Power BI

Сложные запросы более легко выражаются в Kusto, чем в Power Query. Они должны быть реализованы в виде [функций Kusto](kusto/query/functions/index.md)и вызываться в Power BI. Этот метод является обязательным при использовании **DirectQuery** с `let` операторами в запросе Kusto. Поскольку Power BI соединяет два запроса, и `let` операторы нельзя использовать с `join` оператором, могут возникать синтаксические ошибки. Поэтому сохраните каждую часть объединения как функцию Kusto и разрешите Power BI объединить эти две функции.

### <a name="how-to-simulate-a-relative-date-time-operator"></a>Имитация относительного оператора даты и времени

Power BI не содержит *относительный* оператор даты и времени, например `ago()` .
Для имитации `ago()` используйте сочетание `DateTime.FixedLocalNow()` `#duration` функций и Power BI.

Вместо этого запроса с помощью `ago()` оператора:

```kusto
    StormEvents | where StartTime > (now()-5d)
    StormEvents | where StartTime > ago(5d)
``` 

Используйте следующий эквивалентный запрос:

```m
let
    Source = AzureDataExplorer.Contents("help", "Samples", "StormEvents", []),
    #"Filtered Rows" = Table.SelectRows(Source, each [StartTime] > (DateTime.FixedLocalNow()-#duration(5,0,0,0)))
in
    #"Filtered Rows"
```

### <a name="configuring-azure-data-explorer-connector-options-in-m-query"></a>Настройка параметров соединителя Azure обозреватель данных в запросе M

Параметры соединителя Azure обозреватель данных можно настроить с Расширенный редактор PBI на языке запросов M. С помощью этих параметров можно управлять созданным запросом, который отправляется в кластер Azure обозреватель данных.

```m
let
    Source = AzureDataExplorer.Contents("help", "Samples", "StormEvents", [<options>])
in
    Source
```

В запросе M можно использовать любой из следующих параметров:

| Параметр | Образец | Описание
|---|---|---
| MaxRows | `[MaxRows=300000]` | Добавляет `truncationmaxrecords` инструкцию SET в запрос. Переопределяет максимальное число записей по умолчанию, которое запрос может вернуть вызывающему объекту (усечение).
| MaxSize | `[MaxSize=4194304]` | Добавляет `truncationmaxsize` инструкцию SET в запрос. Переопределяет максимальный размер данных по умолчанию, который запрос может вернуть вызывающему объекту (усечение).
| NoTruncate | `[NoTruncate=true]` | Добавляет `notruncation` инструкцию SET в запрос. Включает подавление усечения результатов запроса, возвращаемого вызывающему объекту.
| аддитионалсетстатементс | `[AdditionalSetStatements="set query_datascope=hotcache"]` | Добавляет предоставленные инструкции SET в запрос. Эти инструкции используются для задания параметров запроса на время выполнения запроса. Параметры запроса управляют выполнением запроса и возвращением результатов.
| Без | `[CaseInsensitive=true]` | Создает соединитель, создающий запросы без учета регистра. запросы будут использовать `=~` оператор вместо `==` оператора при сравнении значений.
| Время ожидания | `[Timeout=#duration(0,10,0,0)]` | Настраивает время ожидания клиента и сервера для запроса в указанное время.

> [!NOTE]
> Для достижения желаемого поведения можно объединить несколько параметров: `[NoTruncate=true, CaseInsensitive=true]`

### <a name="reaching-kusto-query-limits"></a>Достижение лимитов запросов Kusto

По умолчанию Kusto запросы возвращают до 500 000 строк или 64 МБ, как описано в разделе [ограничения запросов](kusto/concepts/querylimits.md). Эти значения по умолчанию можно переопределить с помощью **дополнительных параметров** в окне подключения  **Azure обозреватель данных (Kusto)** :

![Дополнительные параметры](media/power-bi-best-practices/advanced-options.png)

Эти параметры выдают [инструкции SET](kusto/query/setstatement.md) с запросом на изменение ограничений по умолчанию для запросов.

* **Ограничить номер записи результата запроса** создает `set truncationmaxrecords`
* **Ограничить размер данных результатов запроса в байтах** создает `set truncationmaxsize`
* **Отключить усечение результирующего набора** создает `set notruncation`

### <a name="case-sensitivity"></a>Чувствительность к регистру

По умолчанию соединитель создает запросы, использующие оператор с учетом регистра `==` при сравнении строковых значений. Если данные не чувствительны к регистру, это не является необходимым поведением. Чтобы изменить созданный запрос, используйте `CaseInsensitive` параметр соединителя:

```m
let
    Source = AzureDataExplorer.Contents("help", "Samples", "StormEvents", [CaseInsensitive=true]),
    #"Filtered Rows" = Table.SelectRows(Source, each [State] == "aLaBama")
in
    #"Filtered Rows"
```

### <a name="using-query-parameters"></a>Использование параметров запроса

[Параметры запроса](kusto/query/queryparametersstatement.md) можно использовать для динамического изменения запроса. 

#### <a name="using-a-query-parameter-in-the-connection-details"></a>Использование параметра запроса в сведениях о подключении

Используйте параметр запроса для фильтрации сведений в запросе и оптимизации производительности запросов.
 
В окне " **изменение запросов** " **Home**  >  **Расширенный редактор**

1. Найдите следующий раздел запроса:

    ```m
    Source = AzureDataExplorer.Contents("<Cluster>", "<Database>", "<Query>", [])
    ```

   Пример:

    ```m
    Source = AzureDataExplorer.Contents("Help", "Samples", "StormEvents | where State == 'ALABAMA' | take 100", [])
    ```

1. Замените соответствующую часть запроса параметром. Разделите запрос на несколько частей и объедините их обратно с помощью амперсанда (&) вместе с параметром.

   Например, в приведенном выше запросе мы рассмотрим `State == 'ALABAMA'` часть и разделите его на: `State == '` и `'` , и мы поместим `State` параметр между ними:

    ```kusto
    "StormEvents | where State == '" & State & "' | take 100"
    ```

1. Если запрос содержит кавычки, их необходимо кодировать правильно. Например, следующий запрос:

   ```kusto
   "StormEvents | where State == "ALABAMA" | take 100"
   ```

   будет отображаться в **Расширенный редактор** , как показано ниже, с двумя кавычками:

   ```kusto
    "StormEvents | where State == ""ALABAMA"" | take 100"
   ```

   Его следует заменить следующим запросом с тремя кавычками:

   ```kusto
   "StormEvents | where State == """ & State & """ | take 100"
   ```

#### <a name="use-a-query-parameter-in-the-query-steps"></a>Использование параметра запроса в шагах запроса

Параметр запроса можно использовать на любом шаге запроса, который его поддерживает. Например, отфильтруйте результаты на основе значения параметра.

![Фильтрация результатов с помощью параметра](media/power-bi-best-practices/filter-using-parameter.png)

### <a name="use-valuenativequery-for-azure-data-explorer-features"></a>Использование функции value. Нативекуери для обозреватель данных Azure

Чтобы использовать функцию обозреватель данных Azure, которая не поддерживается в Power BI, используйте метод [value. нативекуери ()](/powerquery-m/value-nativequery) в M. Этот метод вставляет фрагмент языка запросов Kusto в созданный запрос и может также использоваться для предоставления большего контроля над выполненным запросом.

В следующем примере показано, как использовать `percentiles()` функцию в Azure обозреватель данных.

```m
let
    StormEvents = AzureDataExplorer.Contents(DefaultCluster, DefaultDatabase){[Name = DefaultTable]}[Data],
    Percentiles = Value.NativeQuery(StormEvents, "| summarize percentiles(DamageProperty, 50, 90, 95) by State")
in
    Percentiles
```

### <a name="dont-use-power-bi-data-refresh-scheduler-to-issue-control-commands-to-kusto"></a>Не используйте Power BI Планировщик обновления данных, чтобы выдать команды управления Kusto

Power BI включает Планировщик обновления данных, который может периодически выдавать запросы к источнику данных. Этот механизм не следует использовать для планирования Kusto команд управления, поскольку Power BI предполагает, что все запросы доступны только для чтения.

### <a name="power-bi-can-send-only-short-lt2000-characters-queries-to-kusto"></a>Power BI может передавать только короткие ( &lt; 2000 символов) запросы в Kusto

Если выполнение запроса в Power BI приводит к следующей ошибке: _"DataSource. Error: Web. contents не удалось получить содержимое из..."_ запрос может быть длиннее 2000 символов. Power BI использует **PowerQuery** для запроса Kusto, ВЫДАВАЯ HTTP-запрос GET, который кодирует запрос как часть получаемого URI. Таким образом, Kusto запросы, выданные Power BI, ограничиваются максимальной длиной URI запроса (2000 символов, за вычетом небольшого смещения). В качестве обходного решения можно определить [хранимую функцию](kusto/query/schema-entities/stored-functions.md) в Kusto и иметь Power BI использовать эту функцию в запросе.

## <a name="next-steps"></a>Дальнейшие действия

[Визуализация данных с помощью соединителя Azure Data Explorer для Power BI](power-bi-connector.md)