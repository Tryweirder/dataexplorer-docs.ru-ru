---
title: Материализованные представления — Azure обозреватель данных
description: В этой статье описываются материализованные представления в Azure обозреватель данных.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: yifats
ms.service: data-explorer
ms.topic: reference
ms.date: 08/30/2020
ms.openlocfilehash: c1f96fa2fcfd8989936f31ac0c3b608dabdd6830
ms.sourcegitcommit: 21dee76964bf284ad7c2505a7b0b6896bca182cc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/23/2020
ms.locfileid: "91057216"
---
# <a name="materialized-views-preview"></a>Материализованные представления (Предварительная версия)

[Материализованные представления](../../query/materialized-view-function.md) предоставляют *статистический* запрос к исходной таблице. Материализованные представления всегда возвращают актуальный результат запроса статистической обработки (всегда в актуальном состоянии). Выполнение [запросов к материализованным представлениям](#materialized-views-queries), которое является одноразовым процессом очистки данных, является более производительным, чем выполнение статистической обработки непосредственно над исходной таблицей, которая выполняется в каждом запросе.

> [!NOTE]
> Материализованные представления имеют некоторые [ограничения](#limitations-on-creating-materialized-views)и не гарантированно работают для всех сценариев. Прежде чем приступить к работе с этой функцией, ознакомьтесь с [вопросами производительности](#performance-considerations) .

Используйте следующие команды для управления материализованными представлениями:
* [. Создание материализованных представлений](materialized-view-create.md)
* [. изменение материализованных представлений](materialized-view-alter.md)
* [. Удаление материализованных представлений](materialized-view-drop.md)
* [. Disable |. Включение материализованных представлений](materialized-view-enable-disable.md)
* [. Отображение команд с материализованными представлениями](materialized-view-show-commands.md)

## <a name="why-use-materialized-views"></a>Зачем использовать материализованные представления?

Благодаря инвестиционным ресурсам (хранилищу данных, фоновым циклам ЦП) для материализованных представлений часто используемых агрегатов вы получаете следующие преимущества:

* **Улучшение производительности:** Запросы к материализованным представлениям обычно выполняются лучше, чем запросы к исходной таблице для тех же агрегатных функций.

* **Актуальность:** Запрос материализованных представлений всегда возвращает самые последние результаты независимо от времени последнего материализации. Запрос объединяет материализованный элемент представления с записями в исходной таблице, которые еще не были материализованными ( `delta` часть), всегда предоставляя наиболее актуальные результаты.

* **Снижение затрат.** [запрос материализованных представлений](#materialized-views-queries) потребляет меньше ресурсов из кластера, чем выполнение статистической обработки по всей исходной таблице. Политика хранения исходной таблицы может быть снижена, если требуется только статистическая обработка. Эта установка сокращает затраты на оперативный кэш для исходной таблицы.

## <a name="how-materialized-views-work"></a>Принцип работы материализованных представлений

Материализованный вид состоит из двух компонентов:

* *Материализованные* части — таблица обозреватель данных Azure, содержащая агрегированные записи из исходной таблицы, которые уже обработаны.  Эта таблица всегда содержит одну запись для группировки Group-By.
* *Дельта* — вновь полученные записи в исходной таблице, которые еще не были обработаны.

Запрос материализованных представлений объединяет материализованные части с разностной частью, предоставляя актуальный результат запроса статистической обработки. Процесс автономной материализации принимает новые записи из *разностной* таблицы в материализованный и заменяет существующие записи. Замена выполняется путем перестроения экстентов, содержащих записи для замены. Если записи в *разности* постоянно пересекаются со всеми сегментами данных в *материализованных* компонентах, каждый цикл материализации потребует перестроения всей *материализованных* частей и может не справиться с темпом. Скорость приема будет выше, чем частота материализации. В этом случае представление станет неработоспособным, а *Дельта* будет постоянно расти.

## <a name="create-a-materialized-view"></a>Создание материализованных представлений

Существует два возможных способа создания материализованных представлений, отмеченных параметром « *обратная засыпку* » в [команде CREATE](materialized-view-create.md):
 * **Создать на основе существующих записей в исходной таблице:** 
      * Создание может занять длительное время, в зависимости от количества записей в исходной таблице. Представление не будет доступно для запросов до завершения.
      * При использовании этого параметра команда CREATE должна быть `async` отслеживаема, а выполнение можно отслеживать с помощью команды [. показ операций](../operations.md#show-operations) .
    
      > [!IMPORTANT]
      > * Использование параметра «обратная засыпку» не поддерживается для данных в холодном кэше. При необходимости увеличьте период оперативного кэша для создания представления. Для этого может потребоваться горизонтальное масштабирование.    
      > * Использование параметра «обратная засыпку» может занять длительное время для больших исходных таблиц. Если при выполнении этого процесса происходит сбой, повторная попытка не будет выполнена автоматически, и требуется повторное выполнение команды Create.
    
* **Создание материализованных представлений с помощью:** 
    * Материализованный представление создается пустым и будет включать только записи, полученные после создания представления. Создание такого вида возвращается немедленно, не требует `async` , и представление будет немедленно доступно для запроса.

### <a name="limitations-on-creating-materialized-views"></a>Ограничения на создание материализованных представлений

* Невозможно создать материализованный вид:
    * Поверх другого материализованных представлений.
    * В [базах данных следующих](../../../follower.md). Базы данных следующих действий доступны только для чтения, а материализованные представления — для операций записи.  Материализованные представления, определенные в базах данных лидера, можно запрашивать из их подписчиков, как и любые другие таблицы в лидере. 
* Исходная таблица материализованных представлений:
    * Должна быть таблицей, которая принимается напрямую, либо с помощью одного из [методов приема](../../../ingest-data-overview.md#ingestion-methods-and-tools), с помощью [политики обновления](../updatepolicy.md), либо путем [приема из команд запроса](../data-ingestion/ingest-from-query.md).
        * В частности, использование [перемещения экстентов](../move-extents.md) из других таблиц в исходную таблицу материализованных представлений не поддерживается. Может произойти сбой перемещения экстентов со следующей ошибкой: `Cannot drop/move extents from/to table 'TableName' since Materialized View 'ViewName' is currently processing some of these extents` . 
    * Должна быть включена [Политика инжестионтиме](../ingestiontimepolicy.md) (по умолчанию включена).
    * Невозможно включить для приема потоковой передачи.
    * Не может быть таблицей с ограниченным доступом или таблицей с включенной защитой на уровне строк.
* [Функции курсора](../databasecursor.md#cursor-functions) нельзя использовать на основе материализованных представлений.
* Непрерывный экспорт из материализованных представлений не поддерживается.

### <a name="materialized-view-retention-policy"></a>Политика хранения материализованных представлений

Материализованный вид по умолчанию наследует политику хранения базы данных. Политику можно изменить с помощью [команд управления](../retentionpolicy.md).
   
   * Политика хранения материализованных представлений не связана с политикой хранения исходной таблицы.
   * Если записи исходной таблицы не используются иным образом, политику хранения исходной таблицы можно удалить до минимального значения. Материализованный вид сохранит данные в соответствии с политикой хранения, установленной в представлении. 
   * Хотя материализованные представления находятся в режиме предварительного просмотра, рекомендуется разрешить минимум семь дней, а возможность восстановления — значение true. Этот параметр позволяет быстро восстанавливать ошибки и в целях диагностики.
    
> [!NOTE]
> Политика нулевого хранения в исходной таблице сейчас не поддерживается.

## <a name="materialized-views-queries"></a>Запросы материализованных представлений

Основным способом запроса материализованных представлений является его имя, например запрос ссылки на таблицу. При запросе материализованных представлений он объединяет материализованные части представления с записями в исходной таблице, которые еще не были материализованными. Запрос материализованных представлений всегда будет возвращать самые последние результаты на основе всех записей, полученных в исходной таблице. Дополнительные сведения о разбиении материализованных представлений см. в статье работа с [материализованными представлениями](#how-materialized-views-work). 

Другим способом запроса представления является использование [функции materialized_view ()](../../query/materialized-view-function.md). Этот параметр поддерживает запросы только об материализованных частях представления, при этом указывается максимальная задержка, с которой пользователь готов допускать. Этот параметр не гарантирует возвратить самые актуальные записи, но всегда должен быть более производительным, чем запрос всего представления. Эта функция полезна для сценариев, в которых вы хотите пожертвовать производительностью, например для панелей мониторинга телеметрии.

Представление может участвовать в запросах между кластерами или между базами данных, но не включается в объединение с подстановочными знаками или поиск.

### <a name="query-use-cases"></a>Варианты использования запросов

Ниже приведены распространенные сценарии, которые можно решить с помощью материализованных представлений.

* Последняя запись запроса на сущность с помощью [arg_max () (статистическая функция)](../../query/arg-max-aggfunction.md).
* Отмените дублирование записей в таблице с помощью [любой () (статистической функции)](../../query/any-aggfunction.md).
* Уменьшите разрешение данных, вычисляя периодические статистические данные по необработанным данным. Используйте различные [статистические функции](materialized-view-create.md#supported-aggregation-functions) по периоду времени.
    * Например, используйте `T | summarize dcount(User) by bin(Timestamp, 1d)` для поддержания актуального моментального снимка уникальных пользователей в день.

### <a name="query-examples"></a>Примеры запросов

1. Запрос ко всему представлению. В исходную таблицу включены самые последние записи:
    
    <!-- csl -->
    ```kusto
    ViewName
    ```

1. Запрашивать материализованные части представления, независимо от времени его последнего материализации. 

    <!-- csl -->
    ```kusto
    materialized_view("ViewName")
    ```
    
## <a name="performance-considerations"></a>Вопросы производительности

Основные участники, которые могут повлиять на материализованный работоспособность представления:

* **Ресурсы кластера:** Как и любой другой процесс, выполняемый в кластере, материализованные представления потребляют ресурсы (ЦП, память) от кластера. Если кластер перегружен, добавление материализованных представлений может привести к снижению производительности кластера. Отслеживайте работоспособность кластера с помощью [метрик работоспособности кластера](../../../using-metrics.md#cluster-metrics). [Оптимизированное Автомасштабирование](../../../manage-cluster-horizontal-scaling.md#optimized-autoscale) в настоящее время не учитывает материализованные представления о работоспособности в рамках правил автомасштабирования.

* **Перекрытие с материализованными данными:** Во время материализации все новые записи, полученные в исходной таблице с момента последней материализации (Дельта), обрабатываются и сохранятся в представлении. Чем выше пересечение между новыми записями и уже материализованными записями, тем хуже производительность материализованных представлений. Материализованные представления будут работать лучше, если количество обновляемых записей (например, в `arg_max` представлении) является небольшим подмножеством исходной таблицы. Если все или большинство записей материализованных представлений необходимо обновить в каждом цикле материализации, материализованный вид не будет работать правильно. Для обнаружения этой ситуации используйте [метрики перестроения экстентов](../../../using-metrics.md#materialized-view-metrics) .

* **Скорость приема:** Жестко запрограммированные ограничения на объем данных или скорость приема в исходной таблице материализованных представлений отсутствуют. Однако Рекомендуемая скорость приема для материализованных представлений не превышает 1 ГБ/с. Более высокие показатели приема могут работать нормально. Производительность зависит от размера кластера, доступных ресурсов и объема пересечений с существующими данными.

* **Число материализованных представлений в кластере:** Приведенные выше рекомендации относятся к каждому отдельному материализованныму представлению, определенному в кластере. Каждое представление использует свои собственные ресурсы, и многие представления будут конкурировать друг с другом на доступных ресурсах. Число материализованных представлений в кластере не ограничено жестко запрограммированным ограничением. Однако общая рекомендация — не более 10 материализованных представлений в кластере. [Политика емкости](../capacitypolicy.md#materialized-views-capacity-policy) может быть скорректирована, если в кластере определено более одного материализованных представлений.

* **Определение материализованных представлений**. Определение материализованных представлений должно быть определено в соответствии с рекомендациями по запросам для оптимальной производительности запросов. Дополнительные сведения см. в разделе [создание советов по повышению производительности команд](materialized-view-create.md#performance-tips).

## <a name="materialized-views-monitoring"></a>Мониторинг материализованных представлений

Отслеживайте работоспособность материализованных представлений следующими способами.

* Отслеживайте [показатели материализованных представлений](../../../using-metrics.md#materialized-view-metrics) в портал Azure.
* Наблюдение за `IsHealthy` свойством, возвращаемым при [отображении материализованных представлений](materialized-view-show-commands.md#show-materialized-view).
* Проверьте наличие ошибок с помощью команды " [Показать материализованные" — ошибки представления](materialized-view-show-commands.md#show-materialized-view-failures).

> [!NOTE]
> Материализация никогда не пропускает данные даже в случае постоянных сбоев. Представление всегда гарантированно возвращает самый актуальный моментальный снимок запроса на основе всех записей в исходной таблице. Постоянные сбои значительно снижают производительность запросов, но не будут приводить к неверным результатам в запросах на просмотр.

### <a name="track-resource-consumption"></a>Мониторинг потребления ресурсов

**Материализованные представления потребление ресурсов.** ресурсы, потребляемые процессом материализации материализованных представлений, можно отслеживанию с помощью команды [. показывать команды и запросы](../commands-and-queries.md#show-commands-and-queries) . Отфильтруйте записи для определенного представления, используя следующие команды (Replace `DatabaseName` и `ViewName` ):

<!-- csl -->
```
.show commands-and-queries 
| where Database  == "DatabaseName" and ClientActivityId startswith "DN.MaterializedViews;ViewName;"
```

### <a name="troubleshooting-unhealthy-materialized-views"></a>Устранение неполадок неработоспособных материализованных представлений

`MaterializedViewHealth`Метрика указывает, является ли материализованный представление работоспособным. Материализованные представления могут стать неработоспособными по любой из следующих причин.
* Сбой процесса материализации.
* В кластере недостаточно емкости для материализации всех входящих данных. Сбои при выполнении не будут. Однако представление по-прежнему будет неработоспособным, так как оно будет задержкой и не сможет поддерживать скорость приема.

До тех пор, пока материализованный представление становится неработоспособным, его возраст, отмеченный `MaterializedViewAgeMinutes` метрикой, постепенно увеличится.

### <a name="troubleshooting-examples"></a>Примеры устранения неполадок

Следующие примеры помогут диагностировать и исправить неработоспособные представления.

* **Сбой:** Исходная таблица была изменена или удалена, представление не было задано `autoUpdateSchema` или изменение исходной таблицы не поддерживается для автообновления. <br>
   **Диагностика:**  Создается `MaterializedViewResult` Метрика, а `Result` для измерения устанавливается значение `SourceTableSchemaChange` / `SourceTableNotFound` .

* **Сбой:** Процесс материализации завершается сбоем из-за недостатка ресурсов кластера, и достигнут предел запросов. <br>
  **Диагностика:** `MaterializedViewResult` Измерение метрики `Result` установлено в значение `InsufficientResources` . Azure обозреватель данных попытается автоматически восстановиться из этого состояния, поэтому эта ошибка может быть временной. Однако если представление неработоспособно и эта ошибка постоянно генерируется, то возможно, что конфигурация текущего кластера не сможет поддерживать скорость приема, а кластер должен быть увеличен или уменьшен.

* **Сбой:** Процесс материализации завершается сбоем из-за любых других (неизвестных) причин. <br> 
   **Диагностика**: `MaterializedViewResult` метрика `Result` будет `UnknownError` . Если эта ошибка возникает часто, отправьте запрос в службу поддержки для группы Azure обозреватель данных для дальнейшего изучения.

При отсутствии ошибок материализации `MaterializedViewResult` метрики будут срабатывать при каждом успешном выполнении с помощью `Result` = `Success` . Материализованный вид может быть неработоспособным, несмотря на успешные выполнения, если он задержкой позади ( `Age` выше порогового значения). Такая ситуация может возникнуть в следующих случаях.
   * Материализация замедлится, так как в каждом цикле материализации существует слишком много экстентов для перестроения. Дополнительные сведения о том, почему перестроение экстентов влияет на производительность представления, см. в статье [Работа с материализованными представлениями](#how-materialized-views-work). 
   * Если каждому циклу материализации требуется перестроиться близко к 100% экстентов в представлении, представление может не быть настроено и станет неработоспособным. Количество экстентов, перестроенных в каждом цикле, предоставляется в `MaterializedViewExtentsRebuild` метрике. В этом случае может также помочь увеличение числа экстентов с перестроенной параллельной обработкой в [политике емкости материализованных представлений](../capacitypolicy.md#materialized-views-capacity-policy) . 
   * В кластере есть дополнительные материализованные представления, и у кластера недостаточно емкости для выполнения всех представлений. См. раздел [Политика емкости материализованных представлений](../capacitypolicy.md#materialized-views-capacity-policy) для изменения параметров по умолчанию для количества материализованных представлений, выполняемых параллельно.

## <a name="next-steps"></a>Дальнейшие действия

* [. Создание материализованных представлений](materialized-view-create.md)
* [. изменение материализованных представлений](materialized-view-alter.md)
* [Материализованные представления показывают команды](materialized-view-show-commands.md)
