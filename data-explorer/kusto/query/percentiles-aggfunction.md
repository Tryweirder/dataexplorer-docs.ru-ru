---
title: процентиль (), процентили () — Azure обозреватель данных | Документация Майкрософт
description: В этой статье описывается процентиль (), процентили () в Azure обозреватель данных.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 03/30/2020
ms.openlocfilehash: 58d6458f0a5cf514b1acd240c9adede2022f028b
ms.sourcegitcommit: 1faf502280ebda268cdfbeec2e8ef3d582dfc23e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2020
ms.locfileid: "82619133"
---
# <a name="percentile-percentiles"></a>процентиль (), процентили ()

Возвращает оценку по заданному [значению ближайшего ранга](#nearest-rank-percentile) Генеральной совокупности, определенной *выражением expr*. Точность зависит от плотности заполнения области процентиля. Эта функция может использоваться только в контексте агрегирования внутри [сводки](summarizeoperator.md)

* `percentiles()`функция похожа `percentile()`на, но вычисляет количество значений процентиля (что быстрее, чем вычисление каждого процентиля по отдельности).
* `percentilesw()`функция похожа `percentilew()`на, но вычисляет количество значений взвешенного процентиля (что быстрее, чем вычисление каждого процентиля по отдельности).
* `percentilew()`и `percentilesw()` позволяет вычислить взвешенные процентили. Взвешенный процентили вычисляет заданный процентили в "взвешенном" способе, рассматривая каждое значение, как если бы `Weight` оно было повторено во входных данных.

**Синтаксис**

`percentile(`суммировать *выражение* `,` *процентиля*`)`

`percentiles(`суммировать *выражение* `,` *Percentile1* [`,` *Percentile2*]`)`

`percentiles_array(`суммировать *выражение* `,` *Percentile1* [`,` *Percentile2*]`)`

`percentiles_array(`суммирование *динамического массива* *expr* `,``)`

`percentilew(`суммировать *выражение* `,` *веигхтекспр* *Percentile* процентиль`,``)`

`percentilesw(`суммировать *выражение* `,` *веигхтекспр* `,` *Percentile1* Percentile1 [ *Percentile2*]`,``)`

`percentilesw_array(`суммировать *выражение* `,` *веигхтекспр* `,` *Percentile1* Percentile1 [ *Percentile2*]`,``)`

`percentilesw_array(` *Expr* *WeightExpr* `,` суммировать динамический *массив* выражений веигхтекспр`,``)`

**Аргументы**

* *Expr*: выражение, которое будет использоваться для вычисления агрегата.
* *Веигхтекспр*: выражение, которое будет использоваться в качестве веса значений для вычисления агрегата.
* *Процентиль* — это двойная константа, указывающая процентиль.
* *Динамический массив*. список процентили в динамическом массиве целочисленных значений с плавающей запятой.

**Возвращает**

Возвращает оценку для *выражения* указанного процентили в группе. 

**Примеры**

Значение `Duration` , размер которого превышает 95% выборки и меньше 5% из набора.

```kusto
CallDetailRecords | summarize percentile(Duration, 95) by continent
```

Одновременно вычислить 5, 50 (медиана) и 95:

```kusto
CallDetailRecords 
| summarize percentiles(Duration, 5, 50, 95) by continent
```

:::image type="content" source="images/percentiles-aggfunction/percentiles.png" alt-text="Процентили":::

Результаты показывают, что в Европе 5% вызовов короче 11.55 s, 50% вызовов короче 3 минут, 18,46 секунд, а 95% вызовов короче 40 минут 48 секунд.

Вычисление множественной статистики:

```kusto
CallDetailRecords 
| summarize percentiles(Duration, 5, 50, 95), avg(Duration)
```

## <a name="weighted-percentiles"></a>Взвешенные процентили

Предположим, что измеряется время (продолжительность), необходимое для повторного завершения и повторного выполнения действия. Вместо записи каждого значения измерения их можно сжать, записав каждое значение длительности, округленное до 100 мс, а также сколько раз появилось округленное значение (Буккетсизе).

Можно использовать `summarize percentilesw(Duration, BucketSize, ...)` для вычисления заданного процентили в "взвешенном" варианте, рассматривая каждое значение длительности так, как если бы оно было повторено буккетсизе раз во входных данных, без фактического материализации этих записей.

Пример: Клиент имеет набор значений задержки в миллисекундах: `{ 1, 1, 2, 2, 2, 5, 7, 7, 12, 12, 15, 15, 15, 18, 21, 22, 26, 35 }`.

Чтобы уменьшить пропускную способность и хранилище, выполните предварительное агрегирование для следующих `{ 10, 20, 30, 40, 50, 100 }`контейнеров: и подсчитайте количество событий в каждом контейнере, что дает следующую таблицу Kusto:

:::image type="content" source="images/percentiles-aggfunction/percentilesw-table.png" alt-text="Таблица перцентилесв":::

Который можно считать:
 * 8 событий в контейнере 10 мс (соответствующий подмножеству `{ 1, 1, 2, 2, 2, 5, 7, 7 }`)
 * 6 событий в сегменте 20 мс (соответствующих подмножеству `{ 12, 12, 15, 15, 15, 18 }`)
 * 3 события в контейнере 30ms (соответствующий подмножеству `{ 21, 22, 26 }`)
 * 1 событие в контейнере 40ms (соответствующее подмножеству `{ 35 }`)

На этом этапе исходные данные больше не доступны, и у нас есть количество событий в каждом контейнере. Чтобы вычислить процентили на основе этих данных `percentilesw()` , используйте функцию. Например, для 50, 75 и 99,9 процентили используйте следующий запрос: 

```kusto
datatable (ReqCount:long, LatencyBucket:long) 
[ 
    8, 10, 
    6, 20, 
    3, 30, 
    1, 40 
]
| summarize percentilesw(LatencyBucket, ReqCount, 50, 75, 99.9) 
```

Результат выполнения приведенного выше запроса:


:::image type="content" source="images/percentiles-aggfunction/percentilesw-result.png" alt-text="Перцентилесв результат" border="false":::


Обратите внимание, что приведенный выше запрос `percentiles(LatencyBucket, 50, 75, 99.9)` соответствует функции, если данные были израсходованы на следующую форму:

:::image type="content" source="images/percentiles-aggfunction/percentilesw-rawtable.png" alt-text="Необработанная таблица перцентилесв":::

## <a name="getting-multiple-percentiles-in-an-array"></a>Получение нескольких процентили в массиве

Несколько процентили можно получить в виде массива в одном динамическом столбце, а не в нескольких столбцах: 

```kusto
CallDetailRecords 
| summarize percentiles_array(Duration, 5, 25, 50, 75, 95), avg(Duration)
```

:::image type="content" source="images/percentiles-aggfunction/percentiles-array-result.png" alt-text="Результат массива процентили":::

Аналогичным образом взвешенные процентили можно вернуть в виде динамического массива с помощью`percentilesw_array`

Процентили для `percentiles_array` и `percentilesw_array` могут быть указаны в динамическом массиве целых чисел или числа с плавающей запятой. Массив должен быть константой, но не обязательно должен быть литералом.

```kusto
CallDetailRecords 
| summarize percentiles_array(Duration, dynamic([5, 25, 50, 75, 95])), avg(Duration)
```

```kusto
CallDetailRecords 
| summarize percentiles_array(Duration, range(0, 100, 5)), avg(Duration)
```

## <a name="nearest-rank-percentile"></a>Ближайшее звание процентиль
*P*-й процентиль (0 < *P* <= 100) списка упорядоченных значений (от наименьшего к наибольшему) — это наименьшее значение в списке, в котором *P* процентов данных меньше или равно этому значению ([из статьи Википедии в процентили](https://en.wikipedia.org/wiki/Percentile#The_Nearest_Rank_method)).

Определите *0*-TH процентили, чтобы стать наименьшим элементом совокупности.

>[!NOTE]
> Учитывая приближенную природу вычисления, фактическое возвращаемое значение не может быть членом совокупности.
> Определение ближайшего ранга означает, что *P*= 50 не соответствует последовательному [определению медианы](https://en.wikipedia.org/wiki/Median). При оценке значимости этого несоответствия для конкретного приложения следует учитывать размер совокупности и [ошибки оценки](#estimation-error-in-percentiles) .

## <a name="estimation-error-in-percentiles"></a>Ошибка оценки в процентилях

Статистическая оценка процентилей предоставляет приблизительное значение с помощью [T-Digest](https://github.com/tdunning/t-digest/blob/master/docs/t-digest-paper/histo.pdf). 

>[!NOTE]
> * Границы ошибки оценки изменяются со значением запрошенного процентиля. Наилучшая точность — на концах шкалы [0.. 100]. Процентили 0 и 100 — это точные минимальные и максимальные значения распределения. Точность постепенно снижается к середине шкалы. Он является наихудшим в медианы и ограничен 1%. 
> * Границы ошибки наблюдаются на диапазоне, а не на значении. Предположим, что процентиль (X, 50) вернул значение XM. Оценка гарантирует, что по крайней мере 49% и не более 51% значений X будут меньше или равны XM. Нет теоретического ограничения на разницу между XM и фактическим значением медианы по оси X.
> * Иногда оценка может привести к неточным значениям, но нет надежных условий, которые можно определить, когда это будет так.
