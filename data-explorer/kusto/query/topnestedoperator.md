---
title: Оператор Top-Nested — Azure обозреватель данных
description: В этой статье описывается оператор TOP-Nested в Azure обозреватель данных.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 02/13/2020
ms.openlocfilehash: f87606442dcc5d7c9e7e0fceec379c37169757c3
ms.sourcegitcommit: bb8c61dea193fbbf9ffe37dd200fa36e428aff8c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/13/2020
ms.locfileid: "83370770"
---
# <a name="top-nested-operator"></a>Вложенный оператор верхнего уровня

формирует выборку результатов, состоящую из первых нескольких уровней, где каждый следующий уровень детализирует предыдущие. 

```kusto
T | top-nested 3 of Location with others="Others" by sum(MachinesNumber), top-nested 4 of bin(Timestamp,5m) by sum(MachinesNumber)
```

Это полезно для сценариев визуализации панели мониторинга или при необходимости ответа на вопрос, который звучит следующим образом: "найти значения Top N K1 (с использованием определенного агрегата); для каждого из них найдите значения Top-M априорной оценкой K2 (с использованием другого статистического выражения). ..."

**Синтаксис**

*T* `|` `top-nested` [*N1*] `of` *Выражение1* [ `with others=` *ConstExpr1*] `by` [*AggName1* `=` ] *Aggregation1* [ `asc`  |  `desc` ] [ `,` ...]

**Аргументы**

для каждого правила верхнего уровня вложенности:
* *N1*: количество верхних значений, возвращаемых для каждого уровня иерархии. Необязательно (если не указано, возвращаются все уникальные значения).
* *Expression1*: выражение, по которому выбираются верхние значения. Обычно это либо имя столбца в *T*, либо операция группирования (например, `bin()` ) в таком столбце. 
* *ConstExpr1*: Если указано, то для соответствующего уровня вложенности будет добавлена дополнительная строка, содержащая агрегированный результат для других значений, не включаемых в верхние значения.
* *Aggregation1*: вызов агрегатной функции, которая может иметь одно из следующих значений: [Sum ()](sum-aggfunction.md), [Count ()](count-aggfunction.md), [Max ()](max-aggfunction.md), [min ()](min-aggfunction.md), [DCount ()](dcountif-aggfunction.md), [AVG ()](avg-aggfunction.md), [процентиля ()](percentiles-aggfunction.md), [перцентилев ()](percentiles-aggfunction.md)или любое алжебрик сочетание этих агрегатов.
* `asc` или `desc` (по умолчанию) могут указывать направление выбора элементов в диапазоне: снизу вверх или сверху вниз.

**Возвращает**

Таблица иерархии, включающая входные столбцы и для каждого нового столбца, включает результат статистической обработки для одного и того же уровня для каждого элемента.
Столбцы упорядочиваются в том же порядке, что и входные столбцы, и новый созданный столбец будет близко к агрегированному столбцу. Каждая запись имеет структуру иерархии, где каждое значение выбирается после применения всех предыдущих правил верхнего уровня к всем предыдущим уровням, а затем применяется правило текущего уровня к этому выходу.
Это означает, что первые n значений для уровня i рассчитываются для каждого значения на уровне i-1.
 
**"Советы"**

* Использовать переименование столбцов в для результатов *агрегирования* : T | Верхний вложенный 3 расположения по Мачинеснумберфорлокатион = Sum (Мачинеснумбер)...

* Число возвращаемых записей может быть довольно большим; до (*N1*+ 1) \* (*N2*+ 1) \* ... \* (*NM*+ 1) (где m — это число уровней, а *Ni* — максимальное число для уровня i).

* Статистическая обработка должна получить числовой столбец с статистической функцией, которая является одним из упомянутых выше.

* Используйте `with others=` параметр, чтобы получить агрегированное значение всех других значений, которые не являются значениями Top N на определенном уровне.

* Если вы не заинтересованы в получении `with others=` какого-либо уровня, значения null будут добавлены (для столбца аггреагатед и ключа уровня, см. пример ниже).


* Можно вернуть дополнительные столбцы для выбранных наиболее вложенных кандидатов, добавив дополнительные операторы Top-Nested (см. примеры ниже):

```kusto
top-nested 2 of ...., ..., ..., top-nested of <additionalRequiredColumn1> by max(1), top-nested of <additionalRequiredColumn2> by max(1)
```

**Пример**

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation by sum(BeginLat)
```

|State|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744,823|FT СКОТТ|264,858|
|Канзас|87771.2355000001|Открытый|22855,6206|букклин|488,2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|
|Техас|123400,5101|Открытый|13650,9079|амарилло|246,2598|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|


* Другие примеры:

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State with others = "All Other States" by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation with others = "All Other End Locations" by  sum(BeginLat)


```

|State|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744,823|FT СКОТТ|264,858|
|Канзас|87771.2355000001|Открытый|22855,6206|букклин|488,2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|
|Техас|123400,5101|Открытый|13650,9079|амарилло|246,2598|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|
|Канзас|87771.2355000001|Правоприменение|18744,823|Все остальные конечные расположения|18479,965|
|Канзас|87771.2355000001|Открытый|22855,6206|Все остальные конечные расположения|22367,3749|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|Все остальные конечные расположения|20890,9679|
|Техас|123400,5101|Открытый|13650,9079|Все остальные конечные расположения|13404,6481|
|Техас|123400,5101|Правоприменение|37228,5966|Все остальные конечные расположения|36939,2788|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|Все остальные конечные расположения|13576,2724|
|Канзас|87771.2355000001|||Все остальные конечные расположения|24891,0836|
|Техас|123400,5101|||Все остальные конечные расположения|58523.2932000001|
|Все остальные состояния|1149279,5923|||Все остальные конечные расположения|1149279,5923|


Следующий запрос показывает те же результаты для первого уровня, который использовался в приведенном выше примере:

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
 StormEvents
 | where State !in ('TEXAS', 'KANSAS')
 | summarize sum(BeginLat)
```

|sum_BeginLat|
|---|
|1149279,5923|


Запрос другого столбца (EventType) к верхнему вложенному результату: 

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 1 of EndLocation by sum(BeginLat), top-nested of EventType  by tmp = max(1)
| project-away tmp
```

|State|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|EventType|
|---|---|---|---|---|---|---|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Шквалистый ветер|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Град|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Торнадо|
|Канзас|87771.2355000001|Открытый|22855,6206|букклин|488,2457|Град|
|Канзас|87771.2355000001|Открытый|22855,6206|букклин|488,2457|Шквалистый ветер|
|Канзас|87771.2355000001|Открытый|22855,6206|букклин|488,2457|Наводнение|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|Град|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Град|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Наводнение|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Внезапное наводнение|

Чтобы отсортировать результат по последнему вложенному уровню (в данном примере — Ендлокатион) и задать порядок сортировки индекса для каждого значения на этом уровне (для каждой группы):

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State  by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 4 of EndLocation by  sum(BeginLat)
| order by State , Source, aggregated_EndLocation
| summarize EndLocations = make_list(EndLocation, 10000) , endLocationSums = make_list(aggregated_EndLocation, 10000) by State, Source
| extend indicies = range(0, array_length(EndLocations) - 1, 1)
| mv-expand EndLocations, endLocationSums, indicies
```

|State|Источник|ендлокатионс|ендлокатионсумс|индиЦиес|
|---|---|---|---|---|
|Техас|Подготовленный корректировщик|клауде|421,44|0|
|Техас|Подготовленный корректировщик|амарилло|316,8892|1|
|Техас|Подготовленный корректировщик|далхарт|252,6186|2|
|Техас|Подготовленный корректировщик|перритон|216,7826|3|
|Техас|Правоприменение|перритон|289,3178|0|
|Техас|Правоприменение|леакэй|267,9825|1|
|Техас|Правоприменение|браккеттвилле|264,3483|2|
|Техас|Правоприменение|гилмер|261,9068|3|
|Канзас|Подготовленный корректировщик|ШЭРОН СПГС|388,7404|0|
|Канзас|Подготовленный корректировщик|АТВУДА|358,6136|1|
|Канзас|Подготовленный корректировщик|ленора|317,0718|2|
|Канзас|Подготовленный корректировщик|ГОРОД СКОТТА|307,84|3|
|Канзас|Открытый|букклин|488,2457|0|
|Канзас|Открытый|ашланд|446,4218|1|
|Канзас|Открытый|УРОВЕНЬ|446,11|2|
|Канзас|Открытый|ПРИОСТАНОВИТЬ СОСТОЯНИЕ МЕАДЕ|371,1|3|
