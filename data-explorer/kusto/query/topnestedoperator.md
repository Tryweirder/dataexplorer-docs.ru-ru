---
title: топ-nested оператора - Azure Data Explorer (ru) Документы Майкрософт
description: В этой статье описывается топ-nested оператора в Azure Data Explorer.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 02/13/2020
ms.openlocfilehash: 296c36f4653bec971c71dc210008af7b0d98959a
ms.sourcegitcommit: 47a002b7032a05ef67c4e5e12de7720062645e9e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2020
ms.locfileid: "81505939"
---
# <a name="top-nested-operator"></a>Вложенный оператор верхнего уровня

формирует выборку результатов, состоящую из первых нескольких уровней, где каждый следующий уровень детализирует предыдущие. 

```kusto
T | top-nested 3 of Location with others="Others" by sum(MachinesNumber), top-nested 4 of bin(Timestamp,5m) by sum(MachinesNumber)
```

Это полезно для сценариев визуализации панели мониторинга, или когда необходимо ответить на вопрос, который звучит как: "найти то, что топ-N значения K1 (с использованием некоторых агрегации); для каждого из них найдите значения топ-М К2 (с использованием другой агрегации); ..."

**Синтаксис**

*Т.* `|` `top-nested` *N1* `of` -`with others=` *Выражение1* - *ConstExpr1*- `by` *AggName1* `=`-`,` *Агрегация1* `asc` | `desc`.

**Аргументы**

для каждого первоклассного правила:
* *N1*: Количество верхних значений для возврата для каждого уровня иерархии. Необязательно (если опущено, все различные значения будут возвращены).
* *Expression1*: Выражение, с помощью которого можно выбрать верхние значения. Обычно это либо название столбца в *T,* либо какая-то `bin()`связующая операция (например, ) на такой колонке. 
* *ConstExpr1*: Если указано, то для применимого уровня вложения будет добавлена дополнительная строка, которая содержит агрегированный результат для других значений, которые не включены в верхние значения.
* *Агрегация1*: Вызов функции агрегации, которая может быть одной из: [сумма()](sum-aggfunction.md) [, кол()](count-aggfunction.md), [макс()](max-aggfunction.md), [мин()](min-aggfunction.md), [dcount()](dcountif-aggfunction.md), [avg()](avg-aggfunction.md), [процентили ()](percentiles-aggfunction.md), [percentilew()](percentiles-aggfunction.md), или любой альгебрик сочетание этих агрегаций.
* `asc` или `desc` (по умолчанию) могут указывать направление выбора элементов в диапазоне: снизу вверх или сверху вниз.

**Возвращает**

Иерархиальная таблица, включающая столбцы ввода и для каждого из них, производится новая колонка, которая включает результат агрегации для одного и того же уровня для каждого элемента.
Столбцы расположены в том же порядке входных столбцов, а новый созданный столбец будет близок к агрегированной колонке. Каждая запись имеет иерархическую структуру, в которой каждое значение выбирается после применения всех предыдущих правил верхнего вложения на всех предыдущих уровнях, а затем применяя правило текущего уровня на этом выходе.
Это означает, что верхние значения n для i уровня рассчитываются для каждого значения в уровне i - 1.
 
**Советы**

* Используйте столбцы, переименовавающиеся в результаты *агрегации:* T топ-вложенных 3 Местоположение по MachinesNumberForLocation - сумма (MachinesNumber) ... .

* Число возвращенных записей может быть довольно большим; до (*N1*No1) \* (*N2*No1) \* ... \* (*Нм*No1) (где м количество уровней и *Ni* является верхней рассчитывать на уровне i).

* Агрегация должна получить числовую колонку с функцией агрегации, которая является одной из упомянутых выше.

* Используйте `with others=` опцион для получения агрегированного значения всех других значений, которые не были верхними значениями N на определенном уровне.

* Если вы не заинтересованы в получении `with others=` какого-либо уровня, нулевые значения будут добавлены (для агрегированного столбца и ключа уровня, см. пример ниже).


* Дополнительные столбцы можно вернуть для выбранных кандидатов с верхней частью работы, приложив дополнительные топ-вложенные заявления, подобные этим (см. примеры ниже):

```kusto
top-nested 2 of ...., ..., ..., top-nested of <additionalRequiredColumn1> by max(1), top-nested of <additionalRequiredColumn2> by max(1)
```

**Пример**

```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation by sum(BeginLat)
```

|Состояние|aggregated_State|Источник|aggregated_Source|EndLocation|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744.823|FT СКОТТ|264.858|
|Канзас|87771.2355000001|Public|22855.6206|БАКЛИН|488.2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|ШАРОН СПамик|388.7404|
|Техас|123400.5101|Public|13650.9079|Амарилло|246.2598|
|Техас|123400.5101|Правоприменение|37228.5966|ПЕРРИТОН|289.3178|
|Техас|123400.5101|Подготовленный корректировщик|13997.7124|Клод|421.44|


* С другими примерами:

```kusto
StormEvents
| top-nested 2 of State with others = "All Other States" by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation with others = "All Other End Locations" by  sum(BeginLat)


```

|Состояние|aggregated_State|Источник|aggregated_Source|EndLocation|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744.823|FT СКОТТ|264.858|
|Канзас|87771.2355000001|Public|22855.6206|БАКЛИН|488.2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|ШАРОН СПамик|388.7404|
|Техас|123400.5101|Public|13650.9079|Амарилло|246.2598|
|Техас|123400.5101|Правоприменение|37228.5966|ПЕРРИТОН|289.3178|
|Техас|123400.5101|Подготовленный корректировщик|13997.7124|Клод|421.44|
|Канзас|87771.2355000001|Правоприменение|18744.823|Все остальные места конца|18479.965|
|Канзас|87771.2355000001|Public|22855.6206|Все остальные места конца|22367.3749|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|Все остальные места конца|20890.9679|
|Техас|123400.5101|Public|13650.9079|Все остальные места конца|13404.6481|
|Техас|123400.5101|Правоприменение|37228.5966|Все остальные места конца|36939.2788|
|Техас|123400.5101|Подготовленный корректировщик|13997.7124|Все остальные места конца|13576.2724|
|Канзас|87771.2355000001|||Все остальные места конца|24891.0836|
|Техас|123400.5101|||Все остальные места конца|58523.2932000001|
|Все остальные государства|1149279.5923|||Все остальные места конца|1149279.5923|


Следующий запрос показывает те же результаты для первого уровня, используемого в приведенном выше примере:

```kusto
 StormEvents
 | where State !in ('TEXAS', 'KANSAS')
 | summarize sum(BeginLat)
```

|sum_BeginLat|
|---|
|1149279.5923|


Запрос другого столбца (EventType) на результат, вложенный в топ: 

```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 1 of EndLocation by sum(BeginLat), top-nested of EventType  by tmp = max(1)
| project-away tmp
```

|Состояние|aggregated_State|Источник|aggregated_Source|EndLocation|aggregated_EndLocation|EventType|
|---|---|---|---|---|---|---|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|ШАРОН СПамик|388.7404|Шквалистый ветер|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|ШАРОН СПамик|388.7404|Град|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279.7083|ШАРОН СПамик|388.7404|Торнадо|
|Канзас|87771.2355000001|Public|22855.6206|БАКЛИН|488.2457|Град|
|Канзас|87771.2355000001|Public|22855.6206|БАКЛИН|488.2457|Шквалистый ветер|
|Канзас|87771.2355000001|Public|22855.6206|БАКЛИН|488.2457|Наводнение|
|Техас|123400.5101|Подготовленный корректировщик|13997.7124|Клод|421.44|Град|
|Техас|123400.5101|Правоприменение|37228.5966|ПЕРРИТОН|289.3178|Град|
|Техас|123400.5101|Правоприменение|37228.5966|ПЕРРИТОН|289.3178|Наводнение|
|Техас|123400.5101|Правоприменение|37228.5966|ПЕРРИТОН|289.3178|Внезапное наводнение|

Для того, чтобы сортировать результат по последнему вложенному уровню (в данном примере EndLocation) и дать порядок сортировки индекса для каждого значения на этом уровне (за группу):

```kusto
StormEvents
| top-nested 2 of State  by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 4 of EndLocation by  sum(BeginLat)
| order by State , Source, aggregated_EndLocation
| summarize EndLocations = make_list(EndLocation, 10000) , endLocationSums = make_list(aggregated_EndLocation, 10000) by State, Source
| extend indicies = range(0, array_length(EndLocations) - 1, 1)
| mv-expand EndLocations, endLocationSums, indicies
```

|Состояние|Источник|Конечныеместа|endLocationSums|показательные|
|---|---|---|---|---|
|Техас|Подготовленный корректировщик|Клод|421.44|0|
|Техас|Подготовленный корректировщик|Амарилло|316.8892|1|
|Техас|Подготовленный корректировщик|ДАЛХАРТ|252.6186|2|
|Техас|Подготовленный корректировщик|ПЕРРИТОН|216.7826|3|
|Техас|Правоприменение|ПЕРРИТОН|289.3178|0|
|Техас|Правоприменение|Лики|267.9825|1|
|Техас|Правоприменение|ББРЕКЕДТВИЛЛ|264.3483|2|
|Техас|Правоприменение|Гилмер|261.9068|3|
|Канзас|Подготовленный корректировщик|ШАРОН СПамик|388.7404|0|
|Канзас|Подготовленный корректировщик|Этвуд|358.6136|1|
|Канзас|Подготовленный корректировщик|ЛЕНОРА|317.0718|2|
|Канзас|Подготовленный корректировщик|СКОТТ СИТИ|307.84|3|
|Канзас|Public|БАКЛИН|488.2457|0|
|Канзас|Public|Ashland|446.4218|1|
|Канзас|Public|Защиты|446.11|2|
|Канзас|Public|MEADE STATE PARK|371.1|3|