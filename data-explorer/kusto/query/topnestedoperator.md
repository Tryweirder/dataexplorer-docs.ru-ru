---
title: Оператор Top-Nested — Azure обозреватель данных
description: В этой статье описывается оператор TOP-Nested в Azure обозреватель данных.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: alexans
ms.service: data-explorer
ms.topic: reference
ms.date: 02/13/2020
ms.openlocfilehash: ce56040e2135a455e29a8ff0ce83d832cbf5c5f7
ms.sourcegitcommit: 608539af6ab511aa11d82c17b782641340fc8974
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/20/2020
ms.locfileid: "92243712"
---
# <a name="top-nested-operator"></a>Вложенный оператор верхнего уровня

Создает иерархический выбор статистических данных и значений верхнего уровня, где каждый уровень является уточнением предыдущего.

```kusto
T | top-nested 3 of Location with others="Others" by sum(MachinesNumber), top-nested 4 of bin(Timestamp,5m) by sum(MachinesNumber)
```

`top-nested`Оператор принимает табличные данные в качестве входных данных и одно или несколько агрегатных предложений.
Первое предложение статистической обработки (по левому краю) разделяет входные записи на секции в соответствии с уникальными значениями некоторого выражения для этих записей. Затем предложение сохраняет определенное число записей, которое позволяет развернуть или уменьшить это выражение для записей. Затем предложение Next агрегата применяет аналогичную функцию во вложенном виде. Каждое следующее предложение применяется к секции, созданной предыдущим предложением. Этот процесс продолжится для всех агрегатных предложений.

Например, `top-nested` оператор можно использовать для ответа на следующий вопрос: "для таблицы, содержащей данные о продажах, например" страна "," продавец "и" Сумма проданных ": Каковы первые пять стран по продажам? Каковы три основных продавца в каждой из этих стран?»

## <a name="syntax"></a>Синтаксис

*T* `|` `top-nested` *TopNestedClause2* [ `,` *TopNestedClause2*...]

Где *топнестедклаусе* имеет следующий синтаксис:

[*N*] `of` [ *`ExprName`* `=` ] *`Expr`* [] [] `with` `others` `=` *`ConstExpr`* `by` *`AggName`* `=` *`Aggregation`* [ `asc`  |  `desc` ]

## <a name="arguments"></a>Аргументы

Для каждого *топнестедклаусе*:

* *`N`*: Литерал типа `long` , указывающий, сколько верхних значений следует возвращать для этого уровня иерархии.
  Если этот параметр опущен, будут возвращены все уникальные значения.

* *`ExprName`*: Если указано, задает имя выходного столбца, соответствующего значениям *`Expr`* .

* *`Expr`*: Выражение для входной записи, указывающее, какое значение возвращается для этого уровня иерархии.
  Обычно это ссылка на столбец для входных табличных данных (*T*) или некоторые вычисления (например, `bin()` ) по такому столбцу.

* *`ConstExpr`*: Если задано значение для каждого уровня иерархии, будет добавлена одна запись со значением, которое является агрегатом для всех записей, которые не были "сделали это в верхней части".

* *`AggName`*: Если указано, этот идентификатор задает имя столбца в выходных данных для значения *агрегирования*.

* *`Aggregation`*: Числовое выражение, указывающее агрегат, применяемый ко всем записям, совместно использующие одно и то же значение *`Expr`* . Значение этой статистической схемы определяет, какие из результирующих записей являются "Top".
  
  Поддерживаются следующие статистические функции:
   * [Sum ()](sum-aggfunction.md),
   * [Count ()](count-aggfunction.md),
   * [Max ()](max-aggfunction.md),
   * [min ()](min-aggfunction.md),
   * [DCount ()](dcountif-aggfunction.md),
   * [AVG ()](avg-aggfunction.md),
   * [процентиль ()](percentiles-aggfunction.md)и
   * [перцентилев ()](percentiles-aggfunction.md). Также поддерживается любое сочетание алгебраические агрегатов.

* `asc` или `desc` (значение по умолчанию) может отображаться для управления тем, находится ли выделение на самом деле от «нижнего» или «верхнего» диапазона агрегированных значений.

## <a name="returns"></a>Результаты

Этот оператор возвращает таблицу с двумя столбцами для каждого предложения агрегирования:

* Один столбец содержит различные значения *`Expr`* вычисления предложения (если указано имя столбца *експрнаме* )

* В одном столбце содержится результат вычисления *статистической обработки* (если указано имя столбца *аггрегатионнаме* ).

## <a name="notes"></a>Примечания

Входные столбцы, не указанные в качестве значений, не выводятся *`Expr`* .
Чтобы получить все значения на определенном уровне, добавьте счетчик агрегирования, который:

* Опускает значение *N*
* Использует имя столбца в качестве значения *`Expr`*
* Использует в `Ignore=max(1)` качестве агрегата, а затем игнорирует (или отменяет проекцию) столбца `Ignore` .

Число записей может увеличиваться экспоненциально с числом предложений агрегирования ((N1 + 1) \* (N2 + 1).. \* .). Рост записи выполняется еще быстрее, если не задано ограничение *N* . Примите во внимание, что этот оператор может потреблять значительный объем ресурсов.

Если распределение агрегата является значительно неоднородным, ограничьте количество уникальных возвращаемых значений (с помощью *N*) и используйте `with others=` параметр *ConstExpr* , чтобы получить указание для "веса" всех остальных вариантов.

## <a name="examples"></a>Примеры

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation by sum(BeginLat)
```

|Состояние|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744,823|FT СКОТТ|264,858|
|Канзас|87771.2355000001|Общие|22855,6206|букклин|488,2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|
|Техас|123400,5101|Общие|13650,9079|амарилло|246,2598|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|

Используйте параметр "с другими пользователями":

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State with others = "All Other States" by sum(BeginLat),
  top-nested 3 of Source by sum(BeginLat),
  top-nested 1 of EndLocation with others = "All Other End Locations" by  sum(BeginLat)


```

|Состояние|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|
|---|---|---|---|---|---|
|Канзас|87771.2355000001|Правоприменение|18744,823|FT СКОТТ|264,858|
|Канзас|87771.2355000001|Общие|22855,6206|букклин|488,2457|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|
|Техас|123400,5101|Общие|13650,9079|амарилло|246,2598|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|
|Канзас|87771.2355000001|Правоприменение|18744,823|Все остальные конечные расположения|18479,965|
|Канзас|87771.2355000001|Общие|22855,6206|Все остальные конечные расположения|22367,3749|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|Все остальные конечные расположения|20890,9679|
|Техас|123400,5101|Общие|13650,9079|Все остальные конечные расположения|13404,6481|
|Техас|123400,5101|Правоприменение|37228,5966|Все остальные конечные расположения|36939,2788|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|Все остальные конечные расположения|13576,2724|
|Канзас|87771.2355000001|||Все остальные конечные расположения|24891,0836|
|Техас|123400,5101|||Все остальные конечные расположения|58523.2932000001|
|Все остальные состояния|1149279,5923|||Все остальные конечные расположения|1149279,5923|

Следующий запрос показывает те же результаты для первого уровня, который использовался в приведенном выше примере.

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
 StormEvents
 | where State !in ('TEXAS', 'KANSAS')
 | summarize sum(BeginLat)
```

|sum_BeginLat|
|---|
|1149279,5923|


Запрос другого столбца (EventType) к верхнему вложенному результату.

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 1 of EndLocation by sum(BeginLat), top-nested of EventType  by tmp = max(1)
| project-away tmp
```

|Состояние|aggregated_State|Источник|aggregated_Source|ендлокатион|aggregated_EndLocation|EventType|
|---|---|---|---|---|---|---|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Шквалистый ветер|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Град|
|Канзас|87771.2355000001|Подготовленный корректировщик|21279,7083|ШЭРОН СПГС|388,7404|Торнадо|
|Канзас|87771.2355000001|Общие|22855,6206|букклин|488,2457|Град|
|Канзас|87771.2355000001|Общие|22855,6206|букклин|488,2457|Шквалистый ветер|
|Канзас|87771.2355000001|Общие|22855,6206|букклин|488,2457|Наводнение|
|Техас|123400,5101|Подготовленный корректировщик|13997,7124|клауде|421,44|Град|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Град|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Наводнение|
|Техас|123400,5101|Правоприменение|37228,5966|перритон|289,3178|Внезапное наводнение|

Задайте порядок сортировки индекса для каждого значения на этом уровне (для каждой группы), чтобы отсортировать результат по последнему вложенному уровню (в данном примере — Ендлокатион):

<!-- csl: https://help.kusto.windows.net:443/Samples -->
```kusto
StormEvents
| top-nested 2 of State  by sum(BeginLat),    top-nested 2 of Source by sum(BeginLat),    top-nested 4 of EndLocation by  sum(BeginLat)
| order by State , Source, aggregated_EndLocation
| summarize EndLocations = make_list(EndLocation, 10000) , endLocationSums = make_list(aggregated_EndLocation, 10000) by State, Source
| extend indicies = range(0, array_length(EndLocations) - 1, 1)
| mv-expand EndLocations, endLocationSums, indicies
```

|Состояние|Источник|ендлокатионс|ендлокатионсумс|увеличивают|
|---|---|---|---|---|
|Техас|Подготовленный корректировщик|клауде|421,44|0|
|Техас|Подготовленный корректировщик|амарилло|316,8892|1|
|Техас|Подготовленный корректировщик|далхарт|252,6186|2|
|Техас|Подготовленный корректировщик|перритон|216,7826|3|
|Техас|Правоприменение|перритон|289,3178|0|
|Техас|Правоприменение|леакэй|267,9825|1|
|Техас|Правоприменение|браккеттвилле|264,3483|2|
|Техас|Правоприменение|гилмер|261,9068|3|
|Канзас|Подготовленный корректировщик|ШЭРОН СПГС|388,7404|0|
|Канзас|Подготовленный корректировщик|АТВУДА|358,6136|1|
|Канзас|Подготовленный корректировщик|ленора|317,0718|2|
|Канзас|Подготовленный корректировщик|ГОРОД СКОТТА|307,84|3|
|Канзас|Общие|букклин|488,2457|0|
|Канзас|Общие|ашланд|446,4218|1|
|Канзас|Общие|УРОВЕНЬ|446,11|2|
|Канзас|Общие|ПРИОСТАНОВИТЬ СОСТОЯНИЕ МЕАДЕ|371,1|3|
