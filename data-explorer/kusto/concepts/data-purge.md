---
title: Чистка данных - Azure Data Explorer Документы Майкрософт
description: В этой статье описывается чистка данных в Azure Data Explorer.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 02/24/2020
ms.openlocfilehash: 49d024d1deecd8e0c7bf16eda9917cd237fe6319
ms.sourcegitcommit: 47a002b7032a05ef67c4e5e12de7720062645e9e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2020
ms.locfileid: "81523279"
---
# <a name="data-purge"></a>Очистка данных

>[!Note]
> В этой статье приведены пошаговые инструкции по удалению персональных данных с устройства или из службы. Эти сведения можно использовать для соблюдения обязательств согласно Общему регламенту по защите данных (GDPR). Если вы ищете общую информацию о [GDPR section of the Service Trust portal](https://servicetrust.microsoft.com/ViewPage/GDPRGetStarted)GDPR, см.



В качестве платформы данных Azure Data Explorer (Kusto) поддерживает возможность `.purge` удаления отдельных записей с помощью и связанных с ними команд. Вы также можете [очистки всей таблицы](#purging-an-entire-table).  

> [!WARNING]
> Удаление данных через `.purge` команду предназначено для защиты персональных данных и не должно использоваться в других сценариях. Он не предназначен для поддержки частых запросов на удаление или удаления огромных объемов данных и может оказать значительное влияние на работу службы.

## <a name="purge-guidelines"></a>Руководящие принципы очистки

Настоятельно **рекомендуется,** чтобы группы, которые хранят персональные данные в Azure Data Explorer, делали это только после тщательного проектирования схемы данных и изучения соответствующих политик.

1. В лучшем случае период хранения этих данных является достаточно коротким, а данные автоматически удаляются.
2. Если использование периода удержания не представляется возможным, рекомендуемый подход заключается в изоляции всех данных, подлежащих правилам конфиденциальности, в небольшом количестве таблиц Kusto (оптимально, только одна таблица) и ссылка на них из всех других таблиц. Это позволяет запустить [процесс очистки](#purge-process) данных на небольшом количестве таблиц, вмещающих конфиденциальные данные, и избегать всех других таблиц.
3. Вызывающий абонент должен делать все попытки пакетного выполнения `.purge` команд до 1-2 команд на стол в день.
   Не выдавайте несколько команд, каждая из которых имеет свой собственный предикат идентичности пользователя; скорее, отправьте одну команду, предикат которой включает в себя все идентификаторы пользователей, требующие очистки.

## <a name="purge-process"></a>Процесс очистки

Процесс выборочной очистки данных от Azure Data Explorer происходит следующими шагами:

1. **Фаза 1:** Учитывая название таблицы Kusto и предикат для записи, указывающий, какие записи следует удалить, Кусто сканирует таблицу, чтобы определить осколки данных, которые будут участвовать в очистке данных (есть одна или несколько записей, для которых предикат возвращается верно).
2. **Фаза 2: (Мягкое удаление)** Замените каждый осколок данных в таблице (идентифицированный в шаге (1)) повторно йенсеатом версии, в которой нет записей, для которых предикат возвращается верно.
   До тех пор, пока в таблицу не попадает никаких новых данных, к концу этого этапа запросы больше не будут возвращать данные, для которых предикат возвращается верно. 
   Продолжительность фазы мягкого удаления чистки зависит от количества записей, которые должны быть удалены, их распределения по осколку данных в кластере, количества узлов в кластере, запасных емкостей для операций по удалению и ряда других факторов. Продолжительность фазы 2 может варьироваться от нескольких секунд до нескольких часов.
3. **Фаза 3: (Жесткое удаление)** Отработайте все артефакты хранения, которые могут иметь "ядовитые" данные, и удалите их из хранилища. Этот этап выполняется по крайней мере через 5 дней *после* завершения предыдущего этапа, но не более чем через 30 дней после первоначальной команды, в соответствии с требованиями конфиденциальности данных.

Выдача `.purge` команды запускает этот процесс, который занимает несколько дней. Обратите внимание, что если "плотность" записей, для которых применяется предикат, достаточно велика, процесс будет эффективно повторно похищая все данные в таблице, следовательно, оказывает значительное влияние на производительность и COGS.


## <a name="purge-limitations-and-considerations"></a>Очистка ограничений и соображений

* **Процесс очистки является окончательным и необратимым.** Невозможно "отменить" этот процесс или восстановить данные, которые были удалены. Таким образом, команды, такие как [отменить таблицу,](../management/undo-drop-table-command.md) не могут восстановить очищенные данные, а откат данных в предыдущую версию не может перейти к "до" последней команды очистки.

* Чтобы избежать ошибок, рекомендуется проверить предикат, запустив запрос перед очисткой, чтобы убедиться, что результаты соответствуют ожидаемому результату, или использовать 2-ступенчатый процесс, который возвращает ожидаемое количество записей, которые будут удалены. 

* В качестве меры предосторожности процесс очистки по умолчанию отключается на всех кластерах.
   Включение процесса очистки является одноразовой операцией, которая требует открытия [билета поддержки;](https://ms.portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) пожалуйста, укажите, что вы хотите, `EnabledForPurge` чтобы функция была включена.

* Команда `.purge` выполняется в отношении конечных `https://ingest-[YourClusterName].kusto.windows.net`точек управления данными: .
   Команда требует разрешения [администрирования базы данных](../management/access-control/role-based-authorization.md) в соответствующих базах данных. 
* В связи с воздействием на производительность процесса очистки и гарантией выполнения [руководящих принципов очистки](#purge-guidelines) абонент должен изменить схему данных таким образом, чтобы минимальные таблицы включали соответствующие данные, а пакетные команды в таблице уменьшали значительное влияние процесса очистки COGS.
* Параметр `predicate` команды [.purge](#purge-table-tablename-records-command) позволяет указать записи для очистки.
`Predicate`размер ограничен 63 КБ. При построении: `predicate`
    * Используйте [оператор 'in',](../query/inoperator.md) `where [ColumnName] in ('Id1', 'Id2', .. , 'Id1000')`например. 
        * Обратите внимание на пределы [оператора "в"](../query/inoperator.md) (список может содержать до `1,000,000` значений).
    * Если размер запроса большой, используйте [оператора «внешних данных»,](../query/externaldata-operator.md) `where UserId in (externaldata(UserId:string) ["https://...blob.core.windows.net/path/to/file?..."])`например. Файл хранит список идентимата для очистки.
        * Общий размер запроса, после расширения всех капли внешних данных (общий размер всех капли) не может превышать 64MB. 

## <a name="purge-performance"></a>Производительность очистки

В любой момент времени в кластере может быть выполнен только один запрос на очистку. Все остальные запросы стоят в очереди в состоянии "Запланировано". Размер очереди запроса на очистку должен контролироваться и храниться в надлежащих пределах, чтобы соответствовать требованиям, предъявляемому к вашим данным.

Чтобы сократить время выполнения чистки:
* Уменьшение количества очищенных данных, следуя [рекомендациям по очистке](#purge-guidelines)
* Отрегулируйте [политику кэширования,](../management/cachepolicy.md) так как очистка занимает больше времени на холодных данных.
* Масштабирование кластера

* Увеличьте емкость кластерной чистки, после тщательного рассмотрения, как подробно описано в [Возможностях очистки восстановления потенциала.](../management/capacitypolicy.md#extents-purge-rebuild-capacity) Изменение этого параметра требует открытия [опорного билета](https://ms.portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview)

## <a name="trigger-the-purge-process"></a>Запуск процесса очистки

> [!Note]
> Очистка исполнения вызывается при запуске [таблицы очистки *TableName* записи](#purge-table-tablename-records-command) команды на конечную точку управления данными (**https://ingest-"YourClusterName".kusto.windows.net**).

### <a name="purge-table-tablename-records-command"></a>Команда записей таблицы Очистка *Таблица*

Команда очистки может быть вызвана двумя способами для различных сценариев использования:
1. Программный призыв: одноэтапный вызов, который предназначен для вызова приложений. Вызов этой команды непосредственно вызывает последовательность выполнения очистки.

    **Синтаксис**
     ```kusto
     .purge table [TableName] records in database [DatabaseName] with (noregrets='true') <| [Predicate]
     ```

    > [!NOTE]
    > Создайте эту команду с помощью API CslCommandGenerator, доступного в рамках пакета [NuGet OfGet Клиентской библиотеки Кусто.](../api/netfx/about-kusto-data.md)

1. Вызов человека: двухэтапный процесс, который требует явного подтверждения в качестве отдельного шага. Первый вызов команды возвращает маркер проверки, который должен быть предоставлен для выполнения фактической чистки. Эта последовательность снижает риск непреднамеренного удаляния неверных данных. Использование этой опции может занять много времени для заполнения больших таблиц со значительными данными холодного кэша.
    <!-- If query times-out on DM endpoint (default timeout is 10 minutes), it is recommended to use the [engine `whatif` command](#purge-whatif-command) directly againt the engine endpoint while increasing the [server timeout limit](../concepts/querylimits.md#limit-on-request-execution-time-timeout). Only after you have verified the expected results using the engine whatif command, issue the purge command via the DM endpoint using the 'noregrets' option. -->

     **Синтаксис**
     ```kusto
     // Step #1 - retrieve a verification token (no records will be purged until step #2 is executed)
     .purge table [TableName] records in database [DatabaseName] <| [Predicate]

     // Step #2 - input the verification token to execute purge
     .purge table [TableName] records in database [DatabaseName] with (verificationtoken='<verification token from step #1>') <| [Predicate]
     ```
    
    |Параметры  |Описание  |
    |---------|---------|
    | имя_базы_данных   |   Имя базы данных.      |
    | TableName     |     Имя таблицы    |
    | Predicate    |    Идентифицирует записи для очистки. Ниже приведены ограничения предиката purge ниже. | 
    | нет сожалений    |     Если установлен, запускает одношаговую активацию.    |
    | верификациятокен     |  В двухэтапном сценарии**активации (не установлено сожаления)** этот маркер может быть использован для выполнения второго шага и совершения действия. Если **проверка** не указана, он запустит первый шаг команды, в котором возвращается информация о чистке и маркер, который должен быть передан обратно в команду для выполнения шага #2.   |

    **Очистка предикатных ограничений**
    * Предикат должен быть простым выбором (например, *где «ColumnName» «X»* / *в «ColumnName» в ('X', 'Y', ') и «OtherColumn» «A»).*
    * Несколько фильтров должны быть объединены с `where` "и", а `where [ColumnName] == 'X' and  OtherColumn] == 'Y'` не `where [ColumnName] == 'X' | where [OtherColumn] == 'Y'`отдельные положения (например, и не ).
    * Предикат не может ссылаться на таблицы, кроме продувки таблицы *(TableName).* Предикат может включать только заявление`where`о выборе (). Он не может проецировать определенные столбцы из таблицы (схема вывода при запуске* `table` ' Предикат*' должны соответствовать схеме таблицы).
    * Системные функции `ingestion_time()`(такие как, , `extent_id()`) не поддерживаются как часть предиката.

#### <a name="example-two-step-purge"></a>Пример: Двухступенчатая чистка

1. Чтобы начать чистку в двухэтапном сценарии активации, запустите шаг #1 команды:

    ```kusto
    .purge table MyTable records in database MyDatabase <| where CustomerId in ('X', 'Y')
    ```

    **Вывод**

    |NumRecordstoPurge |РасчетноеВремяисполнения| ПроверкаТокен
    |--|--|--
    |1,596 |00:00:02 |e43c7184ed22f4f23c7a9d7b124d196be2e570096987e5baaaadf65057fa65736b

    Проверка NumRecordsToPurge до запуска шага #2. 
2. Для завершения чистки в двухэтапном сценарии активации используйте маркер проверки, возвращенный из #1 шага, для выполнения шага #2:

    ```kusto
    .purge table MyTable records in database MyDatabase
    with (verificationtoken='e43c7184ed22f4f23c7a9d7b124d196be2e570096987e5baadf65057fa65736b')
    <| where CustomerId in ('X', 'Y')
    ```

    **Вывод**

    |ОперацияId |имя_базы_данных |TableName |Запланированное время |Duration |LastUpdatedon |EngineOperationId |Состояние |СостояниеДетали |EngineStartTime |EngineDuration |Повторы |ClientRequestId |Основной
    |--|--|--|--|--|--|--|--|--|--|--|--|--|--
    |c9651d74-3b80-4183-90bb-bbe9e42eadc4 |MyDatabase |MyTable |2019-01-20 11:41:05.4391686 |00:00:00.1406211 |2019-01-20 11:41:05.4391686 | |По расписанию | | | |0 |Ке. RunCommand;1d0ad28b-f791-4f5a-a60f-0e32318367b7 |AAD приложение id'...

#### <a name="example-single-step-purge"></a>Пример: Одноступенчатая чистка

Чтобы вызвать чистку в одношагодном сценарии активации, запустите следующую команду:

```kusto
.purge table MyTable records in database MyDatabase with (noregrets='true') <| where CustomerId in ('X', 'Y')
```

**Вывод**

|ОперацияId |имя_базы_данных |TableName |Запланированное время |Duration |LastUpdatedon |EngineOperationId |Состояние |СостояниеДетали |EngineStartTime |EngineDuration |Повторы |ClientRequestId |Основной
|--|--|--|--|--|--|--|--|--|--|--|--|--|--
|c9651d74-3b80-4183-90bb-bbe9e42eadc4 |MyDatabase |MyTable |2019-01-20 11:41:05.4391686 |00:00:00.1406211 |2019-01-20 11:41:05.4391686 | |По расписанию | | | |0 |Ке. RunCommand;1d0ad28b-f791-4f5a-a60f-0e32318367b7 |AAD приложение id'...

### <a name="cancel-purge-operation-command"></a>Отмена команды операции очистки

При необходимости можно отменить ожидающие запроса на чистку.

> [!NOTE]
> Эта операция предназначена для сценариев восстановления ошибок. Это не гарантируется успех, и не должно быть частью нормального оперативного потока. Он может быть применен только к запросам в очереди (еще не отправлены в узел двигателя для выполнения). Команда выполняется на конечную точку управления данными.

**Синтаксис**

```kusto
 .cancel purge <OperationId>
 ```

**Пример**

```kusto
 .cancel purge aa894210-1c60-4657-9d21-adb2887993e1
 ```

**Вывод**

Выход этой команды такой же, как и вывод команды 'show purges *OperationId',* показывающий обновленный статус операции очистки, отменяемой. Если попытка удалась, состояние операции обновляется до 'Заброшенного', в противном случае состояние операции не изменяется. 

|ОперацияId |имя_базы_данных |TableName |Запланированное время |Duration |LastUpdatedon |EngineOperationId |Состояние |СостояниеДетали |EngineStartTime |EngineDuration |Повторы |ClientRequestId |Основной
|--|--|--|--|--|--|--|--|--|--|--|--|--|--
|c9651d74-3b80-4183-90bb-bbe9e42eadc4 |MyDatabase |MyTable |2019-01-20 11:41:05.4391686 |00:00:00.1406211 |2019-01-20 11:41:05.4391686 | |Abandoned | | | |0 |Ке. RunCommand;1d0ad28b-f791-4f5a-a60f-0e32318367b7 |AAD приложение id'...

## <a name="track-purge-operation-status"></a>Состояние операции очистки треков 

> [!Note]
> Операции по очистке можно отслеживать с помощью команды [шоу-чистки,](#show-purges-command) выполненной в отношении конечных точек управления данными**https://ingest-(«YourClusterName»..kusto.windows.net**).

Статус и завершенный означает успешное завершение первой фазы операции очистки, то есть записи удалены и больше не доступны для запроса. Предполагается, что клиенты **не** будут отслеживать и проверять завершение второго этапа (жесткое удаление). Этот этап контролируется внутренне Kusto.

### <a name="show-purges-command"></a>показать чистки команды

`Show purges`команда показывает состояние операции очистки, указывая идентификатор операции в течение запрошенного периода времени. 

```kusto
.show purges <OperationId>
.show purges [in database <DatabaseName>]
.show purges from '<StartDate>' [in database <DatabaseName>]
.show purges from '<StartDate>' to '<EndDate>' [in database <DatabaseName>]
```

|Свойства  |Описание  |Обязательный/необязательный
|---------|---------|
|ОперацияId    |      Идентификатор операции управления данными выдался после выполнения одного этапа или второго этапа.   |Обязательный
|StartDate    |   Снижение срока для фильтрации операций. Если опущено, по умолчанию до 24 часов до текущего времени.      |Необязательно
|EndDate    |  Верхний срок для фильтрации операций. Если опущено, по умолчанию к текущему времени.       |Необязательно
|имя_базы_данных    |     Имя базы данных для фильтрации результатов.    |Необязательно

> [!NOTE]
> Статус будет предоставляться только в базах данных, которые клиент имеет разрешения [на администрирование администрирования базы данных.](../management/access-control/role-based-authorization.md)

**Примеры**

```kusto
.show purges
.show purges c9651d74-3b80-4183-90bb-bbe9e42eadc4
.show purges from '2018-01-30 12:00'
.show purges from '2018-01-30 12:00' to '2018-02-25 12:00'
.show purges from '2018-01-30 12:00' to '2018-02-25 12:00' in database MyDatabase
```

**Вывод** 

|ОперацияId |имя_базы_данных |TableName |Запланированное время |Duration |LastUpdatedon |EngineOperationId |Состояние |СостояниеДетали |EngineStartTime |EngineDuration |Повторы |ClientRequestId |Основной
|--|--|--|--|--|--|--|--|--|--|--|--|--|--
|c9651d74-3b80-4183-90bb-bbe9e42eadc4 |MyDatabase |MyTable |2019-01-20 11:41:05.4391686 |00:00:33.6782130 |2019-01-20 11:42:34.6169153 |a0825d4d-6b0f-47f3-a499-54ac5681ab78 |Завершено |Очистка завершена успешно (артефакты хранения до удаления) |2019-01-20 11:41:34.6486506 |00:00:04.4687310 |0 |Ке. RunCommand;1d0ad28b-f791-4f5a-a60f-0e32318367b7 |AAD приложение id'...

* **OperationId** - идентификатор операции DM возвращается при выполнения чистки. 
* **DatabaseName** - имя базы данных (дело чувствительное). 
* **TableName** - название таблицы (дело чувствительное). 
* **ScheduledTime** - время выполнения команды очистки службы DM. 
* **Продолжительность** - общая продолжительность операции очистки, включая время ожидания очереди выполнения DM. 
* **EngineOperationId** - идентификатор работы фактического выполнения очистки в двигателе. 
* **Состояние** - состояние чистки, может быть одним из следующих: 
    * Запланированная - операция по очистке запланирована для выполнения. Если задание остается **запланированным,** вероятно, есть отставание операций по очистке. См [производительность очистки,](#purge-performance) чтобы очистить это отставание. Если операция очистки не удается на переходной ошибки, он будет повторен DM и установлен **на запланированный** снова (так что вы можете увидеть переход операции от **запланированного** к **InProgress** и обратно в **запланированный).**
    * InProgress - очистка операва находится в процессе в двигателе. 
    * Завершено - очистка завершена успешно.
    * BadInput - чистка не удалось на плохой вход и не будет повторен. Это может быть связано с различными проблемами, такими как ошибка синтаксиса в предикате, незаконный предикат для команд очистки, запрос, превышающий пределы (например, более 1M-сущностей оператора внешних данных или более 64 МБ общего расширенного размера запроса) и 404 или 403 ошибки для капли внешних данных.
    * Не удалось - продувка не удалось и не будет повторен. Это может произойти, если операция слишком долго ждала в очереди (более 14 дней) из-за невыполненной работы по другим операциям очистки или ряда сбоев, превышающим лимит повторной попытки. Последний поднимет внутреннее оповещение о мониторинге и будет исследован группой Azure Data Explorer. 
* StateDetails - описание государства.
* EngineStartTime - время выдачи команды двигателю. Если есть большая разница между этим временем и ScheduledTime, как правило, большое отставание очистки операций и кластер не поспевает за темпами. 
* EngineDuration - время фактического выполнения очистки в двигателе. Если чистка была повторена несколько раз, это сумма всех продолжительностей выполнения. 
* Retries - количество повторений операции был повторен службой DM из-за переходной ошибки.
* ClientRequestId - идентификатор активности клиента запроса DM purge. 
* Главный - личность эмитента команды чистки.



## <a name="purging-an-entire-table"></a>Очистка всей таблицы
Очистка таблицы включает в себя падение таблицы и маркировку как очищенную так, чтобы процесс жесткого удаления, описанный в [процессе очистки,](#purge-process) был включен на нее. Удаление таблицы без очистки не удаляет все артефакты хранения (удаляется в соответствии с политикой жесткого удержания, первоначально установленной на столе). Команда `purge table allrecords` быстрая и эффективная и гораздо предпочтительнее процесса записей очистки, если она применима для вашего сценария. 

> [!Note]
> Команда вызывается при запуске [таблицы очистки *TableName* allrecords](#purge-table-tablename-allrecords-command) команды на конечную точку управления данными (**https://ingest-"YourClusterName".kusto.windows.net**).

### <a name="purge-table-tablename-allrecords-command"></a>таблица очистки *ТаблицаНай allrecords* команды

Как и в командовании таблицы[.purgetable, ](#purge-table-tablename-records-command)эта команда может быть вызвана в программном (одноступенчатом) или в ручном (двухступенчатом) режиме.
1. Программный призыв (одноступенчатый):

     **Синтаксис**
     ```kusto
     .purge table [TableName] in database [DatabaseName] allrecords with (noregrets='true')
     ```

2. Вызов человека (два шага):

     **Синтаксис**
     ```kusto
     // Step #1 - retrieve a verification token (the table will not be purged until step #2 is executed)
     .purge table [TableName] in database [DatabaseName] allrecords

     // Step #2 - input the verification token to execute purge
     .purge table [TableName] in database [DatabaseName] allrecords with (verificationtoken='<verification token from step #1>')
     ```

    |Параметры  |Описание  |
    |---------|---------|
    |**Databasename**   |   Имя базы данных.      |
    |**Tablename**     |     Имя таблицы.    |
    |**нет сожалений**    |     Если установлен, запускает одношаговую активацию.    |
    |**верификациятокен**     |  В двухэтапном сценарии**активации (не установлено сожаления)** этот маркер может быть использован для выполнения второго шага и совершения действия. Если **проверка** не указана, он запустит первый шаг команды, на котором возвращается маркер, чтобы вернуться к команде и выполнить шаг команды #2.|

#### <a name="example-two-step-purge"></a>Пример: Двухступенчатая чистка

1. Чтобы начать чистку в двухэтапном сценарии активации, запустите шаг #1 команды: 

    ```kusto
    .purge table MyTable in database MyDatabase allrecords
    ```

    **Вывод**

    | ПроверкаТокен
    |--
    |e43c7184ed22f4f23c7a9d7b124d196be2e570096987e5baaaadf65057fa65736b

1.  Для завершения чистки в двухэтапном сценарии активации используйте маркер проверки, возвращенный из #1 шага, для выполнения шага #2:

    ```kusto
    .purge table MyTable in database MyDatabase allrecords 
    with (verificationtoken='eyJTZXJ2aWNlTmFtZSI6IkVuZ2luZS1pdHNhZ3VpIiwiRGF0YWJhc2VOYW1lIjoiQXp1cmVTdG9yYWdlTG9ncyIsIlRhYmxlTmFtZSI6IkF6dXJlU3RvcmFnZUxvZ3MiLCJQcmVkaWNhdGUiOiIgd2hlcmUgU2VydmVyTGF0ZW5jeSA9PSAyNSJ9')
    ```
    Выход такой же, как и вывод команды '.show таблицы' (возвращается без продуцируется таблицы).

    **Вывод**

    |TableName|имя_базы_данных|Папка|DocString
    |---|---|---|---
    |OtherTable|MyDatabase|---|---


#### <a name="example-single-step-purge"></a>Пример: Одноступенчатая чистка

Чтобы вызвать чистку в одношагодном сценарии активации, запустите следующую команду:

```kusto
.purge table MyTable in database MyDatabase allrecords with (noregrets='true')
```

Выход такой же, как и вывод команды '.show таблицы' (возвращается без продуцируется таблицы).

**Вывод**

|TableName|имя_базы_данных|Папка|DocString
|---|---|---|---
|OtherTable|MyDatabase|---|---


