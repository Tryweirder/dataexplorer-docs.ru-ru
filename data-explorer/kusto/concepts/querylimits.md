---
title: Ограничения запросов в Azure Data Explorer
description: В этой статье описываются ограничения запросов в Azure Data Explorer.
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: alexans
ms.service: data-explorer
ms.topic: reference
ms.date: 03/12/2020
ms.localizationpriority: high
ms.openlocfilehash: a50900a5ea0f0c3d8f25e68a606572093af07432
ms.sourcegitcommit: db99b9d0b5f34341ad3be38cc855c9b80b3c0b0e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100359613"
---
# <a name="query-limits"></a>Ограничения на запросы

Kusto — это обработчик специализированных запросов, который размещает большие наборы данных и удерживает все важные данные в памяти для удовлетворения запросов.
При обработке запросов существует риск того, что они монополизируют ресурсы служб, в которых не реализованы ограничения. Kusto предоставляет несколько встроенных возможностей защиты от таких рисков в виде ограничений запросов по умолчанию. Если вы хотите снять такие ограничения, сначала определите, даст ли вам это какие-либо фактические преимущества.

## <a name="limit-on-request-concurrency"></a>Ограничение на параллелизм запросов

Ограничение на **параллелизм запросов** — это ограничение кластера на число запросов, выполняющихся одновременно.

* Значение по умолчанию для ограничения зависит от SKU виртуальных машин в кластере, на которых эти запросы выполняются, и рассчитывается по формуле `Cores-Per-Node x 10`.
  * Например, для кластера с виртуальными машинами D14v2 с 16 виртуальными ядрами на каждой, значение по умолчанию для ограничения будет равно `16 cores x10 = 160`.
* Значение по умолчанию можно изменить, настроив [политику ограничения частоты запросов](../management/request-rate-limit-policy.md) для группы рабочей нагрузки `default`.
  * Фактическое число запросов, которые можно одновременно выполнять в кластере, зависит от различных факторов. Основные факторы — это SKU виртуальных машин в кластере, доступные ресурсы кластера и шаблоны использования. Политику можно настроить на основе результатов нагрузочных тестов, выполняемых для аналогичных шаблонов использования в рабочей среде.

## <a name="limit-on-result-set-size-result-truncation"></a>Ограничение на размер результирующего набора (усечение результата)

**Усечение результата** — это ограничение, заданное по умолчанию для результирующего набора, возвращаемого запросом. Kusto ограничивает число записей, возвращаемых клиенту, до **500 000**, а общий объем данных для таких записей — до **64 МБ**. При превышении какого-либо из этих ограничений запрос завершается с частичным сбоем выполнения. Превышение общего объема данных приведет к возникновению исключения с таким сообщением:

```
The Kusto DataEngine has failed to execute a query: 'Query result set has exceeded the internal data size limit 67108864 (E_QUERY_RESULT_SET_TOO_LARGE).'
```

Превышение числа записей приведет к сбою с таким исключением:

```
The Kusto DataEngine has failed to execute a query: 'Query result set has exceeded the internal record count limit 500000 (E_QUERY_RESULT_SET_TOO_LARGE).'
```

Есть несколько стратегий для устранения такой ошибки.

* Уменьшите размер результирующего набора, изменив запрос, чтобы он возвращал только интересующие вас данные. Эта стратегия полезна, если изначальный запрос с ошибкой охватывает слишком широкий спектр данных, например не отбрасывает ненужные столбцы данных.
* Уменьшите размер результирующего набора, реализовав в самом запросе последующую обработку, например агрегирование. Такая стратегия подходит для сценариев, в которых выходные данные запроса передаются в другую систему обработки для других операций агрегирования.
* Чтобы экспортировать крупные наборы данных из службы, используйте [функцию экспорта данных](../management/data-export/index.md) вместо запросов.
* Используйте приведенные ниже инструкции `set` или флаги в [свойствах клиентских запросов](../api/netfx/request-properties.md), чтобы указать службе не применять ограничение на запросы.

Вы можете использовать следующие методы для уменьшения размера результирующего набора, создаваемого запросом:

* [Оператор суммирования](../query/summarizeoperator.md) позволяет сгруппировать и агрегировать похожие записи в выходных данных запроса. Вы также можете потенциально получать выборку из некоторых столбцов с помощью [статистической функции any](../query/any-aggfunction.md).
* [Оператор take](../query/takeoperator.md) позволяет получать выборку из выходных данных запроса.
* [Функция substring](../query/substringfunction.md) обрезает широкие столбцы с произвольным текстом.
* [Оператор project](../query/projectoperator.md) удаляет не интересующие вас столбцы из результирующего набора.

Вы можете отключить усечение результатов с помощью параметра запроса `notruncation`.
Но мы все равно рекомендуем использовать ограничения в каком-либо виде.

Пример:

```kusto
set notruncation;
MyTable | take 1000000
```

Результат усечения также можно сделать еще более точным с помощью значений `truncationmaxsize` (максимальный размер данных в байтах, по умолчанию 64 МБ) и `truncationmaxrecords` (максимальное число записей, по умолчанию 500 000). Например, в приведенном ниже запросе усечение результатов выполняется при достижении 1105 записей или размера в 1 МБ (в зависимости от того, что произойдет раньше).

```kusto
set truncationmaxsize=1048576;
set truncationmaxrecords=1105;
MyTable | where User=="UserId1"
```

Отмена ограничения с усечением результатов приведет к тому, что из Kusto будут передаваться все данные.

Вы можете отменить это ограничение, если вы хотите экспортировать данные (с помощью команды `.export`) или выполнить дальнейшее агрегирование. Во втором случае мы рекомендуем для агрегирования использовать Kusto.

Kusto предоставляет несколько клиентских библиотек, которые могут обрабатывать "бесконечно большие" объемы результатов, передавая их вызывающему объекту в потоковом режиме. Используйте одну из таких библиотек и настройте ее для потоковой передачи. Например, используйте клиент .NET Framework (Microsoft.Azure.Kusto.Data) и задайте для свойства потоковой передачи в строке подключения значение *true* или используйте вызов *ExecuteQueryV2Async()* , который всегда выполняет потоковую передачу результатов.

Усечение результатов применяется по умолчанию, а не только к потоку результатов, возвращаемого клиенту. Оно также применяется по умолчанию ко всем вложенным запросам, выдаваемым одним кластером другому кластеру в межкластерном запросе, и имеет аналогичное действие.

### <a name="setting-multiple-result-truncation-properties"></a>Установка нескольких свойств усечения результатов

При использовании инструкций `set` и (или) при указании флагов в [свойствах клиентского запроса](../api/netfx/request-properties.md) применяются следующие условия:

* Если задано свойство `notruncation` и при этом установлен параметр `truncationmaxsize`, `truncationmaxrecords` или `query_take_max_records`, то `notruncation` игнорируется.
* Если `truncationmaxsize`, `truncationmaxrecords` и (или) `query_take_max_records` заданы несколько раз, для каждого свойства применяется *меньшее* значение.

## <a name="limit-on-memory-per-iterator"></a>Ограничение на объем памяти для итератора

**Максимальный объем памяти для итератора результирующего набора** — это еще одно ограничение, используемое Kusto для защиты от неконтролируемых запросов. Это ограничение, представленное параметром запроса `maxmemoryconsumptionperiterator`, задает верхнюю границу для объема памяти, который может занимать отдельный итератор результирующего набора в плане запросов. Оно применяется к определенным итераторам, которые не предусматривают потоковую передачу данных, например к `join`. Ниже приведено несколько сообщений об ошибках, возвращаемых при возникновении такой ситуации:

```
The ClusterBy operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete E_RUNAWAY_QUERY.

The DemultiplexedResultSetCache operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The ExecuteAndCache operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The HashJoin operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The Sort operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The Summarize operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The TopNestedAggregator operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).

The TopNested operator has exceeded the memory budget during evaluation. Results may be incorrect or incomplete (E_RUNAWAY_QUERY).
```

По умолчанию задано значение 5 ГБ. Вы можете увеличить его до объема, не превышающего половину физической памяти на компьютере:

```kusto
set maxmemoryconsumptionperiterator=68719476736;
MyTable | ...
```

Если в запросе используются операторы `summarize`, `join` или `make-series`, вы можете использовать стратегию [смешения запросов](../query/shufflequery.md), чтобы уменьшить нагрузку на память на отдельном компьютере.

В других случаях можно выполнить выборку для набора данных, чтобы не превышать это ограничение. На примере двух приведенных ниже запросов показано, как получить выборку. Первый запрос выполняет статистическую выборку, используя генератор случайных чисел. Второй запрос, с детерминированной выборкой, хэширует некоторые столбцы в наборе данных, обычно с идентификаторами.

```kusto
T | where rand() < 0.1 | ...

T | where hash(UserId, 10) == 1 | ...
```

Если свойство `maxmemoryconsumptionperiterator` задано несколько раз, например в свойствах клиентского запроса и с помощью инструкции `set`, применяется меньшее значение.


## <a name="limit-on-memory-per-node"></a>Ограничение на объем памяти для узла

**Максимальный объем памяти на запрос для узла** — это еще одно ограничение для защиты от неконтролируемых запросов. Это ограничение, представленное параметром запроса `max_memory_consumption_per_query_per_node`, задает верхнюю границу для объема памяти, который может использоваться отдельным узлом для конкретного запроса.

```kusto
set max_memory_consumption_per_query_per_node=68719476736;
MyTable | ...
```

Если свойство `max_memory_consumption_per_query_per_node` задано несколько раз, например в свойствах клиентского запроса и с помощью инструкции `set`, применяется меньшее значение.

Если в запросе используются операторы `summarize`, `join` или `make-series`, вы можете использовать стратегию [смешения запросов](../query/shufflequery.md), чтобы уменьшить нагрузку на память на отдельном компьютере.

## <a name="limit-execution-timeout"></a>Ограничение на время ожидания выполнения

**Время ожидания сервера** — это время ожидания на стороне службы, применяемое ко всем запросам.
Время ожидания для выполняющихся запросов (запросов и управляющих команд) применяется на множестве точек в Kusto:

* в клиентской библиотеке (если она используется);
* на конечной точке службы, которая принимает запрос;
* в подсистеме службы, которая обрабатывает запрос.

По умолчанию для времени ожидания задано 4 минуты для запросов и 10 минут для управляющих команд. При необходимости его можно увеличить (до 1 часа).

* Если вы отправляете запрос с помощью Kusto.Explorer, выберите элементы **Tools (Средства)** &gt; **Options (Параметры)** * &gt; **Connections (Подключения)** &gt; **Query Server Timeout (Время ожидания сервера запросов)** .
* Программно задайте для свойства клиентского запроса `servertimeout` (значение типа `System.TimeSpan`) значение не более 1 часа.

**Примечания о времени ожидания**

* На стороне клиента временем ожидания считается время с момента создания запроса до момента получения ответа на клиенте. Время на считывание полезных данных на клиенте не учитывается во времени ожидания. Оно зависит от того, как быстро вызывающая сторона получает данные из потока.
* Кроме того, на стороне клиента фактическое значение времени ожидания будет немного превышать значение времени ожидания сервера, запрашиваемое пользователем. Такая разница позволяет компенсировать задержку в сети.
* Чтобы автоматически использовать максимально разрешенное время ожидания для запросов, задайте для свойства клиентского запроса `norequesttimeout` значение `true`.

## <a name="limit-on-query-cpu-resource-usage"></a>Ограничение на использование запросом ресурсов ЦП

Kusto позволяет при выполнении запросов использовать все ресурсы ЦП в кластере. Kusto применяет циклический перебор со справедливым распределением ресурсов между запросами, если выполняется несколько запросов. Такой метод гарантирует максимальную производительность для специализированных запросов.
В других случаях вам может потребоваться ограничить объем ресурсов ЦП, используемый определенным запросом. Например, если вы выполняете фоновое задание, система может допускать повышенную задержку для обработки параллельных специализированных запросов с повышенным приоритетом.

Kusto позволяет указать два [свойства клиентского запроса](../api/netfx/request-properties.md) при его выполнении:
*query_fanout_threads_percent* и *query_fanout_nodes_percent*.
Оба этих свойства являются целыми числами, которые по умолчанию принимают максимальное значение (100 %), но могут быть изменены на более низкое значение для определенного запроса.

Первое свойство, *query_fanout_threads_percent*, управляет коэффициентом разветвления для использования потоков.
Если установить для свойства значение 100 %, кластер назначит для выполнения запросов все ЦП в каждом узле, например 16 ЦП в кластере, развернутом на узлах Azure D14.
Если установить для этого свойства значение 50 %, будет использоваться половина ЦП, и т. д.
Числа округляются до целых, поэтому для ЦП свойству можно присвоить значение 0.

Второе свойство, *query_fanout_nodes_percent*, управляет тем, сколько узлов запросов в кластере необходимо использовать для каждой операции распределения вложенных запросов.
Она действует аналогичным образом.

Если свойство `query_fanout_nodes_percent` или `query_fanout_threads_percent` задано несколько раз, например в свойствах клиентского запроса и с помощью инструкции `set`, для каждого свойства применяется меньшее значение.

## <a name="limit-on-query-complexity"></a>Ограничение на сложность запросов

Во время выполнения запроса его текст преобразуется в дерево операторов отношения, представляющих весь запрос.
Если глубина дерева превышает внутренний порог (несколько тысяч ступеней), запрос считается слишком сложным для обработки и будет завершен с кодом ошибки. Сбой указывает на то, что для дерева операторов отношения превышены ограничения.
Ограничения могут быть превышены из-за запросов со связанными длинными списками бинарных операторов. Пример:

```kusto
T 
| where Column == "value1" or 
        Column == "value2" or 
        .... or
        Column == "valueN"
```

В таком случае мы рекомендуем переписать запрос с использованием оператора [`in()`](../query/inoperator.md).

```kusto
T 
| where Column in ("value1", "value2".... "valueN")
```
