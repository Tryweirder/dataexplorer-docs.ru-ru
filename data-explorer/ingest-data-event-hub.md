---
title: Прием данных из концентратора событий в Azure Data Explorer
description: В этой статье описывается, как выполняется прием данных (загрузка) в Azure Data Explorer из концентратора событий.
author: orspod
ms.author: orspodek
ms.reviewer: tzgitlin
ms.service: data-explorer
ms.topic: how-to
ms.date: 08/13/2020
ms.localizationpriority: high
ms.openlocfilehash: 3ffead54d87354b9c7f6a6a370fccfaeac670207
ms.sourcegitcommit: d19b4214625eeb1ec7aec4fd6c92007a07c76ebc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2020
ms.locfileid: "102472212"
---
# <a name="ingest-data-from-event-hub-into-azure-data-explorer"></a>Прием данных из концентратора событий в Azure Data Explorer

> [!div class="op_single_selector"]
> * [Портал](ingest-data-event-hub.md)
> * [Один щелчок](one-click-event-hub.md)
> * [C#](data-connection-event-hub-csharp.md)
> * [Python](data-connection-event-hub-python.md)
> * [Шаблон Azure Resource Manager](data-connection-event-hub-resource-manager.md)

[!INCLUDE [data-connector-intro](includes/data-connector-intro.md)]

Обозреватель данных Azure позволяет выполнять прием (загрузку) данных из концентраторов событий, платформы потоковой передачи больших данных и службы приема данных событий. [Центры событий](/azure/event-hubs/event-hubs-about) могут обрабатывать миллионы событий в секунду практически в режиме реального времени. Выполнив действия, приведенные в этой статье, вы научитесь создавать концентратор событий, подключаться к нему из Azure Data Explorer и просматривать поток данных, проходящих через систему.

Общие сведения о приеме данных из концентратора событий в Azure Data Explorer см. в статье [Подключение к концентратору событий](ingest-data-event-hub-overview.md).

## <a name="prerequisites"></a>Предварительные требования

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.
* [Тестовый кластер и база данных](create-cluster-database-portal.md).
* [Пример приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), создающего данные и отправляющего их в концентратор событий. Загрузите пример приложения в систему.
* [Visual Studio 2019](https://visualstudio.microsoft.com/vs/) для запуска примера приложения.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Войдите на [портал Azure](https://portal.azure.com/).

## <a name="create-an-event-hub"></a>Создание концентратора событий

Изучив эту статью, вы научитесь создавать демонстрационные данные, а затем передавать их в концентратор событий. Первым шагом является создание концентратора событий. Это делается с помощью шаблона Azure Resource Manager на портале Azure.

1. Нажмите следующую кнопку, чтобы начать развертывание и создание концентратора событий. Чтобы закончить выполнение инструкций из этой статьи, щелкните правой кнопкой мыши и выберите ссылку **Открыть в новом окне**.

    [![Кнопка "Развертывание в Azure"](media/ingest-data-event-hub/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-event-hubs-create-event-hub-and-consumer-group%2Fazuredeploy.json)

    Кнопка **Развернуть в Azure** выполняет переход на портал Azure для заполнения формы развертывания.

    ![Создание формы концентратора событий](media/ingest-data-event-hub/deploy-to-azure.png)

1. Выберите подписку, в которой нужно создать концентратор событий, и создайте группу ресурсов с именем *test-hub-rg*.

    ![Создание группы ресурсов](media/ingest-data-event-hub/create-resource-group.png)

1. Заполните форму, указав следующую информацию.

    ![Форма развертывания](media/ingest-data-event-hub/deployment-form.png)

    Используйте значения по умолчанию для всех параметров, отсутствующих в следующей таблице.

    **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Подписка | Ваша подписка | Выберите подписку Azure, которую нужно использовать для своего концентратора событий.|
    | Группа ресурсов | *test-hub-rg* | Создайте новую группу ресурсов. |
    | Расположение | *западная часть США* | Для работы над этой статьей выберите *Западная часть США*. Для производственной системы выберите регион, лучше всего соответствующий вашим потребностям. Создайте пространство имен концентратора событий в одном расположении с кластером Kusto, чтобы обеспечить оптимальную производительность (крайне важно для пространств имен концентраторов событий с высокой пропускной способностью).
    | Имя пространства имен | Уникальное имя пространства имен | Выберите уникальное имя, идентифицирующее пространство имен. Например, *mytestnamespace*. К введенному имени добавляется имя домена *servicebus.windows.net*. Имя может содержать только буквы, цифры и дефисы. Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. Длина значения в символах должна быть от 6 до 50.
    | Имя концентратора событий | *test-hub* | Концентратор событий находится в пространстве имен, предоставляющем уникальный контейнер области. Имя концентратора событий должно быть уникальным в пределах пространства имен. |
    | Имя группы потребителей | *test-group* | Группы получателей событий позволяют каждому из нескольких получающих события приложений иметь отдельное представление потока событий. |
    | | |

1. Выберите **Купить**, что подтверждает создание ресурсов в вашей подписке.

1. На панели инструментов щелкните **Уведомления**, чтобы отслеживать процесс подготовки. Успешное выполнение развертывания может занять несколько минут, но теперь можно перейти к следующему шагу.

    ![Значок "Уведомления"](media/ingest-data-event-hub/notifications.png)

## <a name="create-a-target-table-in-azure-data-explorer"></a>Создание целевой таблицы в обозревателе данных Azure

Теперь создадим таблицу в обозревателе данных Azure, в которые концентраторы событий будут отправлять данные. Таблица создается в кластере и базе данных, представленных в разделе **Необходимые компоненты**.

1. Войдите на портал Azure, перейдите в свой кластер и выберите **Запрос**.

    ![Ссылка приложения запроса](media/ingest-data-event-hub/query-explorer-link.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить**, чтобы создать таблицу (TestTable), которая будет принимать входящие данные.

    ```Kusto
    .create table TestTable (TimeStamp: datetime, Name: string, Metric: int, Source:string)
    ```

    ![Выполнение создания запроса](media/ingest-data-event-hub/run-create-query.png)

1. Скопируйте следующую команду в окно и выберите **Выполнить** для сопоставления входящих данных JSON с именами столбцов и типами данных таблицы (TestTable).

    ```Kusto
    .create table TestTable ingestion json mapping 'TestMapping' '[{"column":"TimeStamp", "Properties": {"Path": "$.timeStamp"}},{"column":"Name", "Properties": {"Path":"$.name"}} ,{"column":"Metric", "Properties": {"Path":"$.metric"}}, {"column":"Source", "Properties": {"Path":"$.source"}}]'
    ```

## <a name="connect-to-the-event-hub"></a>Подключение к концентратору событий

Теперь вы можете подключиться к концентратору событий с помощью Azure Data Explorer. После установки этого подключения данные, поступающие в концентратор событий, передаются потоком в тестовую таблицу, созданную ранее в этой статье.

1. Выберите **уведомления** на панели инструментов, чтобы убедиться в успешном развертывании концентратора событий.

1. В созданном кластере выберите **Базы данных**, затем **TestDatabase**.

    ![Выбор тестовой базы данных](media/ingest-data-event-hub/select-test-database.png)

1. Выберите **Прием данных** и **Добавить подключение к данным**. 

    :::image type="content" source="media/ingest-data-event-hub/event-hub-connection.png" alt-text="Экран &quot;Выделенные пункты &quot;Прием данных&quot; и &quot;Добавить подключение к данным&quot; в концентраторе событий — Azure Data Explorer&quot;":::

### <a name="create-a-data-connection"></a>Создание подключения к данным

1. Заполните форму, указав следующую информацию.

    :::image type="content" source="media/ingest-data-event-hub/data-connection-pane.png" alt-text="Экран &quot;Область &quot;Подключение к данным&quot; концентратора событий — Azure Data Explorer&quot;":::

    **Параметр** | **Рекомендуемое значение** | **Описание поля**
    |---|---|---|
    | Имя подключения к данным | *test-hub-connection* | Имя создаваемого подключения к обозревателю данных Azure.|
    | Подписка |      | Идентификатор подписки, в которой размещается ресурс концентратора событий.  |
    | пространство имен концентратора событий; | Уникальное имя пространства имен | Имя, выбранное ранее и определяющее пространство имен. |
    | Концентратор событий | *test-hub* | Созданный концентратор событий. |
    | Группа потребителей | *test-group* | Группа потребителей, определенная в созданном концентраторе событий. |
    | Свойства системы событий | Выбор необходимых свойств | Системные [свойства концентратора событий](/azure/service-bus-messaging/service-bus-amqp-protocol-guide#message-annotations). При добавлении системных свойств выполните [создание](kusto/management/create-table-command.md) или [обновление](kusto/management/alter-table-command.md) схемы таблицы, а также [сопоставление](kusto/management/mappings.md), чтобы добавить выбранные свойства. Дополнительные сведения об ограничениях системных свойств см. в разделе [Сопоставление свойств системы событий](#event-system-properties-mapping). |
    | Сжатие | *Нет* | Тип сжатия полезных данных сообщений концентратора событий. Поддерживаемые типы сжатия: *нет, GZip*.|
    
#### <a name="target-table"></a>Целевая таблица

Существуют два варианта маршрутизации принятых данных: *статическая* и *динамическая*. В этой статье используется статическая маршрутизация, для которой нужно указать имя таблицы, формат данных и сопоставление в качестве значений по умолчанию. Если сообщение концентратора событий содержит сведения о маршрутизации данных, эти сведения переопределят параметры по умолчанию.

1. Заполните следующие параметры маршрутизации:
  
   :::image type="content" source="media/ingest-data-event-hub/default-routing-settings.png" alt-text="Экран &quot;Default routing settings (Параметры маршрутизации по умолчанию) для приема данных в концентратор событий — Azure Data Explorer&quot;":::
        
   |**Параметр** | **Рекомендуемое значение** | **Описание поля**
   |---|---|---|
   | Имя таблицы | *TestTable* | Таблица, созданная в базе данных **TestDatabase**. |
   | Формат данных | *JSON* | Поддерживаются форматы: Avro, CSV, JSON, MULTILINE JSON, ORC, PARQUET, PSV, SCSV, SOHSV, TSV, TXT, TSVE, APACHEAVRO и W3CLOG. |
   | Сопоставление | *TestMapping* | [Сопоставление](kusto/management/mappings.md), созданное в таблице **TestDatabase**, которое сопоставляет входящие данные с именами столбцов и типами данных **TestTable**. Является обязательным для JSON, MULTILINE JSON и AVRO и необязательным для других форматов.|
    
   > [!NOTE]
   > * Вы не обязаны указывать все значения для **параметров маршрутизации по умолчанию**. Принимаются также частично заполненные параметры.
   > * Принимаются только события, поставленные в очередь после создания подключения к данным.

1. Нажмите кнопку **создания**. 

### <a name="event-system-properties-mapping"></a>Сопоставление свойств системы событий

[!INCLUDE [event-hub-system-mapping](includes/event-hub-system-mapping.md)]

Если вы выбрали в разделе **Источник данных** таблицы пункт **Свойства системы событий**, необходимо добавить [системные свойства](ingest-data-event-hub-overview.md#system-properties) в схему и сопоставление таблицы.

## <a name="copy-the-connection-string"></a>Копирование строки подключения

При запуске [примера приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), указанного в списке предварительных требований, потребуется строка подключения для пространства имен концентратора событий.

1. В созданном пространстве имен концентратора событий выберите **Политики общего доступа**, затем **RootManageSharedAccessKey**.

    ![Политики общего доступа](media/ingest-data-event-hub/shared-access-policies.png)

1. Скопируйте значение в поле **Строка подключения — первичный ключ**. Вставьте его при работе со следующим разделом.

    ![Строка подключения](media/ingest-data-event-hub/connection-string.png)

## <a name="generate-sample-data"></a>Создание примера данных

Используйте [пример приложения](https://github.com/Azure-Samples/event-hubs-dotnet-ingest), загруженный для создания данных.

1. Откройте решение для примера приложения в Visual Studio.

1. В файле *program.cs* замените константу `eventHubName` именем вашего концентратора событий, а константу `connectionString` — строкой подключения, скопированной из пространства имен концентратора событий.

    ```csharp
    const string eventHubName = "test-hub";
    // Copy the connection string ("Connection string-primary key") from your Event Hub namespace.
    const string connectionString = @"<YourConnectionString>";
    ```

1. Выполните сборку и запуск приложения. Приложение отправляет сообщения в концентратор событий, и он печатает состояние каждые десять секунд.

1. После отправки приложением нескольких сообщений перейдите к следующему шагу: просмотрите поток данных, поступающий в концентратор событий центра и тестовую таблицу.

## <a name="review-the-data-flow"></a>Просмотр потока данных

Теперь, когда приложение создает данные, вы можете просмотреть поток данных, поступающих из концентратора событий в таблицу в кластере.

1. На портале Azure, в разделе своего концентратора событий, во время работы приложения появится пик активности.

    ![График концентратора событий](media/ingest-data-event-hub/event-hub-graph.png)

1. Чтобы проверить, сколько сообщений поступило в базу данных к этому моменту, выполните следующий запрос в тестовой базе данных.

    ```Kusto
    TestTable
    | count
    ```

1. Чтобы увидеть содержимое сообщений, выполните следующий запрос:

    ```Kusto
    TestTable
    ```

    Результат должен выглядеть примерно так:

    ![Набор результатов для сообщений](media/ingest-data-event-hub/message-result-set.png)

    > [!NOTE]
    > * В Azure Data Explorer настроена политика агрегирования (пакетной обработки) для приема данных, предназначенных для оптимизации процесса. Политика пакетной обработки по умолчанию настроена на запечатывание пакета при выполнении одного из следующих условий: превышено максимальное время задержки в 5 минут, превышен общий размер в 1 ГБ или превышено количество в 1000 больших двоичных объектов. В связи с этим может возникнуть задержка. Дополнительные сведения см. на странице о [политике пакетной обработки](kusto/management/batchingpolicy.md). 
    > * Прием данных концентратора событий содержит время отклика концентратора событий, равное 10 секундам или 1 МБ. 
    > * Настройте таблицу таким образом, чтобы она поддерживала потоковую передачу и устраняла задержку во времени отклика. См. статью [Политика потоковой передачи](kusto/management/streamingingestionpolicy.md). 

## <a name="clean-up-resources"></a>Очистка ресурсов

Если не планируется повторно использовать концентратор событий, очистите **test-hub-rg**, чтобы избежать взимания оплаты.

1. На портале Azure выберите **Группа ресурсов** слева, а затем выберите созданную группу ресурсов.  

    Если левое меню свернуто, нажмите ![кнопку "Развернуть",](media/ingest-data-event-hub/expand.png) чтобы развернуть его.

   ![Выбор удаляемой группы ресурсов](media/ingest-data-event-hub/delete-resources-select.png)

1. В разделе **test-resource-group** выберите **Удалить группу ресурсов**.

1. В новом окне введите имя удаляемой группы ресурсов (*test-hub-rg*) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

* [Запрос данных в Azure Data Explorer](web-query-data.md)
