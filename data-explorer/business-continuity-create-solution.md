---
title: Создание решений по обеспечению непрерывности бизнес-процессов и аварийного восстановления с помощью Azure обозреватель данных
description: В этой статье описывается создание решений обеспечения непрерывности бизнес-процессов и аварийного восстановления с помощью Azure обозреватель данных
author: orspod
ms.author: orspodek
ms.reviewer: herauch
ms.service: data-explorer
ms.topic: conceptual
ms.date: 08/05/2020
ms.openlocfilehash: 4c3a4a522192510ffb1a4ac2a1c46d9ddaf7c823
ms.sourcegitcommit: 83202ec6fec0ce98fdf993bbb72adc985d6d9c78
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87877243"
---
# <a name="create-business-continuity-and-disaster-recovery-solutions-with-azure-data-explorer"></a>Создание решений по обеспечению непрерывности бизнес-процессов и аварийного восстановления с помощью Azure обозреватель данных

В этой статье подробно описано, как подготовиться к региональному простою Azure путем репликации ресурсов, управления и приема Azure обозреватель данных в разных регионах Azure. Приведен пример приема данных с помощью концентратора событий. Оптимизация затрат также обсуждается для различных конфигураций архитектуры. Более подробное рассмотрение рекомендаций по архитектуре и решений для восстановления см. в статье [Обзор непрерывности бизнес-процессов](business-continuity-overview.md).

## <a name="prepare-for-azure-regional-outage-to-protect-your-data"></a>Подготовка к региональному простою Azure для защиты данных

Azure обозреватель данных не поддерживает автоматическую защиту в случае сбоя всего региона Azure. Такое прерывание может произойти во время стихийного сбоя, например землетрясения. Если требуется решение в случае аварийного восстановления, выполните следующие действия, чтобы обеспечить непрерывность бизнес-процессов. На этих шагах вы реплицируете кластеры, управление и прием данных в двух парных регионах Azure.

1. [Создайте два или более независимых кластера](#create-multiple-independent-clusters) в двух парных регионах Azure.
1. [Репликация всех действий управления](#replicate-management-activities) , таких как создание новых таблиц или управление ролями пользователей в каждом кластере.
1. Прием данных в каждый кластер параллельно.

### <a name="create-multiple-independent-clusters"></a>Создание нескольких независимых кластеров

Создавайте более одного [кластера Azure обозреватель данных](create-cluster-database-portal.md) в нескольких регионах.
Убедитесь, что в [парных регионах Azure](/azure/best-practices-availability-paired-regions)созданы по крайней мере два из этих кластеров.

На следующем рисунке показаны реплики, три кластера в трех разных регионах. 

:::image type="content" source="media/business-continuity-create-solution/independent-clusters.png" alt-text="Создание независимых кластеров":::

### <a name="replicate-management-activities"></a>Репликация действий управления

Репликация действий управления с одинаковой конфигурацией кластера в каждой реплике.

1. Создайте в каждой реплике одинаково: 
    * [Databases]: You can use the [Azure portal to create a new database](create-cluster-database-portal.md#create-a-database) or one of our [SDKs](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/kusto/Microsoft.Azure.Management.Kusto).
    * [Таблицы](kusto/management/create-table-command.md)
    * [Сопоставления](kusto/management/create-ingestion-mapping-command.md)
    * [Политики](kusto/management/policies.md)

1. Управление [проверкой подлинности и авторизацией](kusto/management/security-roles.md) для каждой реплики.

    :::image type="content" source="media/business-continuity-create-solution/regional-duplicate-management.png" alt-text="Дубликаты действий управления":::    

### <a name="configure-data-ingestion"></a>Настройка приема данных

Согласованная Настройка приема данных в каждом кластере. Следующие методы приема используют следующие расширенные возможности обеспечения непрерывности бизнес-процессов.

|Метод приема  |Функция аварийного восстановления  |
|---------|---------|
|[Центр Интернета вещей](/azure/iot-hub/iot-hub-ha-dr#cross-region-dr)  |[Отработка отказа Майкрософт и отработка отказа вручную](/azure/iot-hub/iot-hub-ha-dr#cross-region-dr) |
|[Концентратор событий](ingest-data-event-hub.md) | Аварийное восстановление метаданных с использованием [основного и дополнительного пространства имен аварийного восстановления](/azure/event-hubs/event-hubs-geo-dr)     |
|[Прием данных из хранилища с помощью подписки службы "Сетка событий"](ingest-data-event-grid.md) |  Реализация [географического аварийного восстановления](/azure/event-hubs/event-hubs-geo-dr) для сообщений, созданных BLOB-объектом, отправляемых в концентратор событий и [стратегии аварийного восстановления и отработки отказа учетной записи](/azure/storage/common/storage-disaster-recovery-guidance)       |

## <a name="disaster-recovery-solution-using-event-hub-ingestion"></a>Решение для аварийного восстановления с использованием приема концентратора событий

После завершения подготовки к [региональному простою Azure для защиты данных](#prepare-for-azure-regional-outage-to-protect-your-data)данные и управление распределяются в несколько регионов. Если в одном регионе произойдет сбой, Azure обозреватель данных сможет использовать другие реплики. 

### <a name="set-up-ingestion-using-event-hub"></a>Настройка приема с помощью концентратора событий

В следующем примере используется прием через концентратор событий. Настроен [поток отработки отказа](/azure/event-hubs/event-hubs-geo-dr#setup-and-failover-flow) , а Azure обозреватель данных принимает данные из псевдонима. Прием [данных из концентратора событий](ingest-data-event-hub.md) с помощью уникальной группы потребителей на каждую реплику кластера. В противном случае трафик будет распределяться вместо его репликации.

> [!NOTE] 
> Прием через концентратор событий, центр Интернета вещей и хранилище являются надежными. Если кластер недоступен в течение определенного времени, он будет отслеживаться позже и вставлять все ожидающие сообщения или большие двоичные объекты. Этот процесс основан на [контрольных точках](/azure/event-hubs/event-hubs-features#checkpointing).

:::image type="content" source="media/business-continuity-create-solution/event-hub-management-scheme.png" alt-text="Прием через концентратор событий":::

Как показано на приведенной ниже схеме, источники данных создают события в концентраторе событий, настроенном для отработки отказа, и Каждая реплика обозреватель данных Azure использует эти события. Такие компоненты визуализации данных, как Power BI, Grafana или пакет SDK, могут запрашивать одну из реплик.

:::image type="content" source="media/business-continuity-create-solution/data-sources-visualization.png" alt-text="Источники данных для визуализации данных":::

## <a name="optimize-costs"></a>Оптимизация затрат

Теперь вы можете оптимизировать реплики, используя следующие методы:

* [Создание конфигурации "активный — горячий"](#create-an-active-hot-standby-configuration)
* [Запуск и завершение реплик](#start-and-stop-the-replicas)
* [Реализация службы приложений высокой доступности](#implement-a-highly-available-application-service)
* [Оптимизация затрат в конфигурации "активный — активный"](#optimize-cost-in-an-active-active-configuration)

### <a name="create-an-active-hot-standby-configuration"></a>Создание конфигурации "активный — горячий"

Репликация и обновление установки обозреватель данных Azure линейно увеличивают стоимость с учетом количества реплик. Чтобы оптимизировать затраты, можно реализовать архитектурный вариант для балансировки времени, отработки отказа и затрат.
В конфигурации "активный — активный" Оптимизация затрат реализована с помощью пассивных реплик обозреватель данных Azure. Эти реплики включаются только в случае аварии в основном регионе (например, региона а). Реплики в регионах B и C не должны быть активными 24/7, что значительно сокращает затраты. Однако в большинстве случаев производительность этих реплик не будет так хороша, как основной кластер. Дополнительные сведения см. в разделе " [Активная — горячая резервная конфигурация](business-continuity-overview.md#active-hot-standby-configuration)".

На приведенном ниже рисунке только один кластер принимает данные из концентратора событий. Основной кластер в регионе A выполняет [непрерывный экспорт данных](kusto/management/data-export/continuous-data-export.md) из всех данных в учетную запись хранения. Вторичные реплики имеют доступ к данным с помощью [внешних таблиц](kusto/query/schema-entities/externaltables.md).

:::image type="content" source="media/business-continuity-create-solution/active-hot-standby-scheme.png" alt-text="Архитектура для режима "активный/активный"":::

### <a name="start-and-stop-the-replicas"></a>Запуск и завершение реплик 

Запускать и прекращать вторичные реплики можно с помощью одного из следующих методов.

* [Соединитель Azure обозреватель данных для автоматического управления питанием (Предварительная версия)](flow.md)

* Кнопка " **Отключить** " на вкладке " **обзор** " в портал Azure. Дополнительные сведения см. [в разделе Завершение и перезапуск кластера](create-cluster-database-portal.md#stop-and-restart-the-cluster).

* Azure CLI: 

```kusto
az kusto cluster stop --name=<clusterName> --resource-group=<rgName> --subscription=<subscriptionId>” 
```

### <a name="implement-a-highly-available-application-service"></a>Реализация службы приложений высокой доступности

#### <a name="create-the-azure-app-service-bcdr-client"></a>Создание клиента BCDR для службы приложений Azure

В этом разделе показано, как создать [службу приложений Azure](https://azure.microsoft.com/services/app-service/) , которая поддерживает подключение к одному первичному и нескольким вторичным кластерам Azure обозреватель данных. На следующем рисунке показана установка службы приложений Azure.

:::image type="content" source="media/business-continuity-create-solution/app-service-setup.png" alt-text="Создание службы приложений Azure":::

> [!TIP]
> Наличие нескольких подключений между репликами в одной службе обеспечивает повышенную доступность. Эта настройка не только полезна в случае региональных простоев.  

1. Используйте этот [стандартный код для службы приложений](https://github.com/Azure/azure-kusto-bcdr-boilerplate). Для реализации клиента с несколькими кластерами был создан класс [адксбкдрклиент](https://github.com/Azure/azure-kusto-bcdr-boilerplate/blob/master/webapp/ADX/AdxBcdrClient.cs) . Каждый запрос, выполняемый с помощью этого клиента, будет отправлен [первым в основной кластер](https://github.com/Azure/azure-kusto-bcdr-boilerplate/blob/26f8c092982cb8a3757761217627c0e94928ee07/webapp/ADX/AdxBcdrClient.cs#L69). В случае сбоя запрос будет отправлен на вторичные реплики.

1. Используйте [Настраиваемые метрики Application Insights](/azure/azure-monitor/app/api-custom-events-metrics) для измерения производительности и запроса распространения на первичные и вторичные кластеры. 

#### <a name="test-the-azure-app-service-bcdr-client"></a>Тестирование клиента BCDR для службы приложений Azure

Мы выполнили тест с использованием нескольких реплик обозреватель данных Azure. После имитации сбоя основного и дополнительного кластеров можно увидеть, что клиент BCDR службы приложений работает в соответствии с предполагаемым поведением.

:::image type="content" source="media/business-continuity-create-solution/simulation-verify-service.png" alt-text="Проверка клиента BCDR службы приложений":::

Кластеры Azure обозреватель данных распределяются по регионам Западной Европы (2xD14v2 PRIMARY), Южной Восточная Азия и восточной части США (2xD11v2). 

:::image type="content" source="media/business-continuity-create-solution/performance-test-query-time.png" alt-text="Время ответа на запрос перекрестной планеты":::

> [!NOTE]
> Более медленное время отклика обусловлено различными номерами SKU и запросами Cross-планеты.

#### <a name="perform-dynamic-or-static-routing"></a>Выполнение динамической или статической маршрутизации

Используйте [методы маршрутизации диспетчера трафика Azure](/azure/traffic-manager/traffic-manager-routing-methods) для динамической или статической маршрутизации запросов.  Диспетчер трафика Azure — это балансировщик нагрузки трафика на основе DNS, который позволяет распределять трафик службы приложений. Этот трафик оптимизирован для служб в глобальных регионах Azure, обеспечивая высокий уровень доступности и скорость реагирования. 

Вы также можете использовать [маршрутизацию на основе передней дверцы Azure](/azure/frontdoor/front-door-routing-methods). Сравнение этих двух методов см. в разделе [Балансировка нагрузки с помощью пакета доставки приложений Azure](/azure/frontdoor/front-door-lb-with-azure-app-delivery-suite).

### <a name="optimize-cost-in-an-active-active-configuration"></a>Оптимизация затрат в конфигурации "активный — активный"

Использование конфигурации "активный — активный" для аварийного восстановления увеличивает затраты линейно. Стоимость включает в себя узлы, хранилище, разметку и увеличенную стоимость сети для [пропускной способности](https://azure.microsoft.com/pricing/details/bandwidth/).

#### <a name="use-optimized-autoscale-to-optimize-costs"></a>Использование оптимизированного автомасштабирования для оптимизации затрат

Используйте [оптимизированную функцию автомасштабирования](manage-cluster-horizontal-scaling.md#optimized-autoscale) , чтобы настроить горизонтальное масштабирование для вторичных кластеров. Они должны быть измерениями, чтобы они могли обрабатывать загрузку приема. Когда основной кластер недоступен, вторичные кластеры получают больше трафика и масштабируются в соответствии с конфигурацией. 

Использование оптимизированного автомасштабирования в этом примере сохраняет примерно 50% стоимости в сравнении с тем же горизонтальным и вертикальным масштабированием во всех репликах.

## <a name="next-steps"></a>Дальнейшие шаги

Приступите к работе с [обзором непрерывности бизнес-процессов и аварийного восстановления](business-continuity-overview.md).
