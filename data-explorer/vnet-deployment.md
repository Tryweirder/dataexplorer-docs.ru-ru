---
title: Развертывание обозреватель данных Azure в виртуальной сети
description: Узнайте, как развернуть обозреватель данных Azure в виртуальной сети.
author: orspod
ms.author: orspodek
ms.reviewer: basaba
ms.service: data-explorer
ms.topic: how-to
ms.date: 10/31/2019
ms.openlocfilehash: 93860688f798c3b9ac2552052f22cc1ca1ca565e
ms.sourcegitcommit: 91e7d49a1046575bbc63a4f25724656ebfc070db
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/30/2020
ms.locfileid: "89151201"
---
# <a name="deploy-azure-data-explorer-cluster-into-your-virtual-network"></a>Развертывание кластера Azure обозреватель данных в виртуальной сети

В этой статье объясняются ресурсы, которые имеются при развертывании кластера Azure обозреватель данных в настраиваемой виртуальной сети Azure. Эта информация поможет вам развернуть кластер в подсети виртуальной сети (VNet). Дополнительные сведения о виртуальных сетях Azure см. в статье [что такое виртуальная сеть Azure?](/azure/virtual-network/virtual-networks-overview)

   ![Схема виртуальной сети](media/vnet-deployment/vnet-diagram.png)

Azure обозреватель данных поддерживает развертывание кластера в подсети в виртуальной сети (VNet). Эта возможность позволяет выполнять следующие задачи:

* Примените правила [группы безопасности сети](/azure/virtual-network/security-overview) (NSG) к трафику кластера Azure обозреватель данных.
* Подключите локальную сеть к подсети кластера Azure обозреватель данных.
* Обеспечьте безопасность источников подключения к данным ([концентратора событий](/azure/event-hubs/event-hubs-about) и [Сетка событий](/azure/event-grid/overview)) с [конечными точками службы](/azure/virtual-network/virtual-network-service-endpoints-overview).

## <a name="access-your-azure-data-explorer-cluster-in-your-vnet"></a>Доступ к кластеру Azure обозреватель данных в виртуальной сети

Вы можете получить доступ к кластеру Azure обозреватель данных с помощью следующих IP-адресов для каждой службы (механизма и служб управления данными):

* **Частный IP-адрес**: используется для доступа к кластеру в виртуальной сети.
* **Общедоступный IP-адрес**. используется для доступа к кластеру извне виртуальной сети для управления и мониторинга, а также в качестве исходного адреса для исходящих подключений, запущенных из кластера.

Для доступа к службе создаются следующие записи DNS: 

* `[clustername].[geo-region].kusto.windows.net` (подсистема) `ingest-[clustername].[geo-region].kusto.windows.net` (Управление данными) сопоставляется с общедоступным IP-адресом для каждой службы. 

* `private-[clustername].[geo-region].kusto.windows.net` (подсистема) `private-ingest-[clustername].[geo-region].kusto.windows.net` (Управление данными) сопоставляется с частным IP-адресом для каждой службы.

## <a name="plan-subnet-size-in-your-vnet"></a>Планирование размера подсети в виртуальной сети

Размер подсети, используемой для размещения кластера Azure обозреватель данных, нельзя изменить после развертывания подсети. В виртуальной сети Azure обозреватель данных использует один частный IP-адрес для каждой виртуальной машины и два частных IP-адреса для внутренних подсистем балансировки нагрузки (механизм и управление данными). Сеть Azure также использует пять IP-адресов для каждой подсети. Azure обозреватель данных подготавливает две виртуальные машины для службы управления данными. Виртуальные машины службы ядра подготавливаются к масштабированию конфигурации на уровне пользователя.

Общее число IP-адресов:

| Использовать | Число адресов |
| --- | --- |
| Служба ядра | 1 на экземпляр |
| Служба управления данными | 2 |
| Внутренние подсистемы балансировки нагрузки | 2 |
| Зарезервированные адреса Azure | 5 |
| **Всего** | **#engine_instances + 9** |

> [!IMPORTANT]
> Размер подсети должен быть заранее запланирован, так как он не может быть изменен после развертывания Azure обозреватель данных. Поэтому необходимо соответствующим образом зарезервировать необходимый размер подсети.

## <a name="service-endpoints-for-connecting-to-azure-data-explorer"></a>Конечные точки службы для подключения к Azure обозреватель данных

[Конечные точки службы Azure](/azure/virtual-network/virtual-network-service-endpoints-overview) позволяют защищать ресурсы нескольких клиентов Azure в виртуальной сети.
Развертывание кластера обозреватель данных Azure в подсети позволяет настроить подключения к данным с помощью [концентратора событий](/azure/event-hubs/event-hubs-about) или службы " [Сетка событий](/azure/event-grid/overview) " при ограничении базовых ресурсов для подсети Azure обозреватель данных.

> [!NOTE]
> При использовании программы установки EventGrid с [хранилищем](/azure/storage/common/storage-introduction) и [концентратором событий] учетная запись хранения, используемая в подписке, может быть заблокирована с конечными точками службы в подсети Azure обозреватель данных и разрешать Доверенные службы платформы Azure в [конфигурации брандмауэра](/azure/storage/common/storage-network-security), но концентратор событий не может включить конечную точку службы, так как она не поддерживает доверенные [службы платформы Azure](/azure/event-hubs/event-hubs-service-endpoints).

## <a name="private-endpoints"></a>Частные конечные точки

[Частные конечные точки](/azure/private-link/private-endpoint-overview) обеспечивают закрытый доступ к ресурсам Azure (например, к хранилищу, концентратору событий или Data Lake Gen 2) и используют частный IP-адрес из виртуальной сети, подставляя ресурс в виртуальную сеть.
Создайте [закрытую конечную точку](/azure/private-link/private-endpoint-overview) для ресурсов, используемых подключениями к данным, такими как концентратор событий и хранилище, а также внешние таблицы, такие как хранилище, Data Lake Gen 2 и база данных SQL из виртуальной сети для закрытого доступа к базовым ресурсам.

 [!NOTE]
 > Для настройки частной конечной точки требуется [Настройка DNS](/azure/private-link/private-endpoint-dns). поддерживается только настройка [Частная зона DNS зоны Azure](/azure/dns/private-dns-privatednszone) . Пользовательский DNS-сервер не поддерживается. 

## <a name="dependencies-for-vnet-deployment"></a>Зависимости для развертывания виртуальной сети

### <a name="network-security-groups-configuration"></a>Конфигурация групп безопасности сети

[Группы безопасности сети (NSG)](/azure/virtual-network/security-overview) обеспечивают возможность управления доступом к сети в виртуальной сети. Доступ к обозреватель данных Azure можно получить с помощью двух конечных точек: HTTPs (443) и TDS (1433). Следующие правила NSG должны быть настроены таким образом, чтобы разрешить доступ к этим конечным точкам для управления, мониторинга и правильной работы кластера. Дополнительные правила зависят от ваших руководств по безопасности.

#### <a name="inbound-nsg-configuration"></a>Конфигурация входящей NSG

| **Использование**   | **От**   | **Чтобы**   | **Протокол**   |
| --- | --- | --- | --- |
| Управление  |[ADX Management Addresses](#azure-data-explorer-management-ip-addresses)/Азуредатаексплорерманажемент (сервицетаг) | Подсеть ADX: 443  | TCP  |
| Мониторинг работоспособности  | [Адреса мониторинга работоспособности ADX](#health-monitoring-addresses)  | Подсеть ADX: 443  | TCP  |
| Внутренняя связь ADX  | Подсеть ADX: все порты  | Подсеть ADX: все порты  | All  |
| Разрешить входящий трафик балансировщика нагрузки Azure (проба работоспособности)  | AzureLoadBalancer  | Подсеть ADX: 80443  | TCP  |

#### <a name="outbound-nsg-configuration"></a>Исходящая конфигурация NSG

| **Использование**   | **От**   | **Чтобы**   | **Протокол**   |
| --- | --- | --- | --- |
| Зависимость от службы хранилища Azure  | Подсеть ADX  | Хранилище: 443  | TCP  |
| Зависимость от Azure Data Lake  | Подсеть ADX  | AzureDataLake: 443  | TCP  |
| Получение EventHub и мониторинг службы  | Подсеть ADX  | EventHub: 443, 5671  | TCP  |
| Опубликовать метрики  | Подсеть ADX  | Азуремонитор: 443 | TCP  |
| Active Directory (если применимо) | Подсеть ADX | AzureActiveDirectory: 443 | TCP |
| Центр сертификации | Подсеть ADX | Интернет: 80 | TCP |
| Взаимодействие изнутри  | Подсеть ADX  | Подсеть ADX: все порты  | All  |
| Порты, используемые для `sql\_request` `http\_request` подключаемых модулей и  | Подсеть ADX  | Интернет: настраиваемый  | TCP  |

### <a name="relevant-ip-addresses"></a>Соответствующие IP-адреса

#### <a name="azure-data-explorer-management-ip-addresses"></a>IP-адреса управления обозреватель данных Azure

> [!NOTE]
> Для будущих развертываний используйте тег службы Азуредатаексплорер.

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 20.37.26.134 |
| Central2 Австралия | 20.39.99.177 |
| Восточная Австралия | 40.82.217.84 |
| Australia Southeast | 20.40.161.39 |
| бразилсаус | 191.233.25.183 |
| Центральная Канада | 40.82.188.208 |
| Восточная Канада | 40.80.255.12 |
| Центральная Индия | 40.81.249.251, 104.211.98.159 |
| Центральная часть США | 40.67.188.68 |
| Центральная часть США (EUAP) | 40.89.56.69 |
| Восточный Китай 2 | 139.217.184.92 |
| Северный Китай 2 | 139.217.60.6 |
| Восточная Азия | 20.189.74.103 |
| Восточная часть США | 52.224.146.56 |
| восточная часть США 2 | 52.232.230.201 |
| Восточная США 2 (EUAP) | 52.253.226.110 |
| Центральная Франция | 40.66.57.91 |
| Южная Франция | 40.82.236.24 |
| Japan East | 20.43.89.90 |
| Западная Япония | 40.81.184.86 |
| Республика Корея, центральный регион | 40.82.156.149 |
| Республика Корея, южный регион | 40.80.234.9 |
| Центрально-северная часть США | 40.81.45.254 |
| Северная Европа | 52.142.91.221 |
| Северная часть ЮАР; | 102.133.129.138 |
| Западная часть ЮАР | 102.133.0.97 |
| Центрально-южная часть США | 20.45.3.60 |
| Southeast Asia | 40.119.203.252 |
| Южная Индия | 40.81.72.110, 104.211.224.189 |
| южная часть Соединенного Королевства | 40.81.154.254 |
| западная часть Соединенного Королевства | 40.81.122.39 |
| Центральная часть США (DoD) | 52.182.33.66 |
| Восточная часть США (DoD) | 52.181.33.69 |
| USGov (Аризона) | 52.244.33.193 |
| USGov (Техас) | 52.243.157.34 |
| USGov (Вирджиния) | 52.227.228.88 |
| центрально-западная часть США | 52.159.55.120 |
| Западная Европа | 51.145.176.215 |
| Западная Индия | 40.81.88.112, 104.211.160.120 |
| западная часть США | 13.64.38.225 |
| Западная часть США 2 | 40.90.219.23 |

#### <a name="health-monitoring-addresses"></a>Адреса мониторинга работоспособности

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 191.239.64.128 |
| Центральная Австралия 2 | 191.239.64.128 |
| Восточная Австралия | 191.239.64.128 |
| Australia Southeast | 191.239.160.47 |
| Brazil South | 23.98.145.105 |
| Центральная Канада | 168.61.212.201 |
| Восточная Канада | 168.61.212.201 |
| Центральная Индия | 23.99.5.162 |
| Центральная часть США | 168.61.212.201 |
| Центральная часть США (EUAP) | 168.61.212.201 |
| Восточный Китай 2 | 40.73.96.39 |
| Северный Китай 2 | 40.73.33.105 |
| Восточная Азия | 168.63.212.33 |
| Восточная часть США | 137.116.81.189 |
| Восточная часть США 2 | 137.116.81.189 |
| Восточная часть США 2 (EUAP) | 137.116.81.189 |
| Центральная Франция | 23.97.212.5 |
| Южная Франция | 23.97.212.5 |
| Japan East | 138.91.19.129 |
| Западная Япония | 138.91.19.129 |
| Республика Корея, центральный регион | 138.91.19.129 |
| Республика Корея, южный регион | 138.91.19.129 |
| Центрально-северная часть США | 23.96.212.108 |
| Северная Европа | 191.235.212.69 
| Северная часть ЮАР; | 104.211.224.189 |
| Западная часть ЮАР | 104.211.224.189 |
| Центрально-южная часть США | 23.98.145.105 |
| Южная Индия | 23.99.5.162 |
| Southeast Asia | 168.63.173.234 |
| южная часть Соединенного Королевства | 23.97.212.5 |
| западная часть Соединенного Королевства | 23.97.212.5 |
| Центральная часть США (DoD) | 52.238.116.34 |
| Восточная часть США (DoD) | 52.238.116.34 |
| USGov (Аризона) | 52.244.48.35 |
| USGov (Техас) | 52.238.116.34 |
| USGov (Вирджиния) | 23.97.0.26 |
| центрально-западная часть США | 168.61.212.201 |
| Западная Европа | 23.97.212.5 |
| Западная Индия | 23.99.5.162 |
| западная часть США | 23.99.5.162 |
| Западная часть США 2 | 23.99.5.162, 104.210.32.14 |

## <a name="disable-access-to-azure-data-explorer-from-the-public-ip"></a>Отключение доступа к обозреватель данных Azure из общедоступного IP-адреса

Если вы хотите полностью отключить доступ к обозреватель данных Azure через общедоступный IP-адрес, создайте другое правило для входящего подключения в NSG. Это правило должно иметь более низкий [приоритет](/azure/virtual-network/security-overview#security-rules) (большее число). 

| **Использование**   | **Source** | **Тег службы источника** | **Диапазоны исходных портов**  | **Назначение** | **Диапазоны портов назначения** | * * Протокол * * | **Действие** | * * Приоритет * * |
| ---   | --- | --- | ---  | --- | --- | --- | --- | --- |
| Отключить доступ из Интернета | Тег службы | Интернет | *  | VirtualNetwork | * | Любой | Запрет | большее число, чем приведенные выше правила |

Это правило позволит подключаться к кластеру Azure обозреватель данных только с помощью следующих записей DNS (сопоставленных с частным IP-адресом для каждой службы):
* `private-[clustername].[geo-region].kusto.windows.net` ядре
* `private-ingest-[clustername].[geo-region].kusto.windows.net` (Управление данными)

## <a name="expressroute-setup"></a>Установка ExpressRoute

Используйте ExpressRoute для подключения к виртуальной сети Azure в локальной сети. Распространенной установкой является объявление маршрута по умолчанию (0.0.0.0/0) через сеанс протокол BGP (BGP). Это вынуждает трафик, поступающий из виртуальной сети, перенаправляться в локальную сеть клиента, которая может удалить трафик, что приведет к прерыванию исходящих потоков. Чтобы преодолеть это значение по умолчанию, можно настроить [определяемый пользователем маршрут (UDR)](/azure/virtual-network/virtual-networks-udr-overview#user-defined) (0.0.0.0/0), а следующий прыжок будет иметь значение " *Интернет*". Так как UDR имеет приоритет над BGP, трафик будет направлен в Интернет.

## <a name="securing-outbound-traffic-with-firewall"></a>Защита исходящего трафика с помощью брандмауэра

Если вы хотите защитить исходящий трафик с помощью [брандмауэра Azure](/azure/firewall/overview) или любого виртуального устройства для ограничения доменных имен, в брандмауэре должны быть разрешены следующие полные доменные имена (FQDN).

```
prod.warmpath.msftcloudes.com:443
gcs.prod.monitoring.core.windows.net:443
production.diagnostics.monitoring.core.windows.net:443
graph.windows.net:443
*.update.microsoft.com:443
shavamanifestcdnprod1.azureedge.net:443
login.live.com:443
wdcp.microsoft.com:443
login.microsoftonline.com:443
azureprofilerfrontdoor.cloudapp.net:443
*.core.windows.net:443
*.servicebus.windows.net:443,5671
shoebox2.metrics.nsatc.net:443
prod-dsts.dsts.core.windows.net:443
ocsp.msocsp.com:80
*.windowsupdate.com:80
ocsp.digicert.com:80
go.microsoft.com:80
dmd.metaservices.microsoft.com:80
www.msftconnecttest.com:80
crl.microsoft.com:80
www.microsoft.com:80
adl.windows.com:80
crl3.digicert.com:80
```

> [!NOTE]
> Если вы используете [брандмауэр Azure](/azure/firewall/overview) , необходимо добавить "Сетевое правило", чтобы разрешить *азуремонитор* (тег службы) для порта 443.

Кроме того, необходимо определить [таблицу маршрутов](/azure/virtual-network/virtual-networks-udr-overview) в подсети с [адресами управления](#azure-data-explorer-management-ip-addresses) и [адресами мониторинга работоспособности](#health-monitoring-addresses) в *Интернете* следующего прыжка, чтобы предотвратить возникновение проблем с асимметричными маршрутами.

Например, для региона " **Западная часть США** " необходимо определить следующие определяемые пользователем маршруты:

| Имя | Префикс адреса | Следующий прыжок |
| --- | --- | --- |
| ADX_Management | 13.64.38.225/32 | Интернет |
| ADX_Monitoring | 23.99.5.162/32 | Интернет |

## <a name="deploy-azure-data-explorer-cluster-into-your-vnet-using-an-azure-resource-manager-template"></a>Развертывание кластера Azure обозреватель данных в виртуальной сети с помощью шаблона Azure Resource Manager

Чтобы развернуть кластер Azure обозреватель данных в виртуальной сети, используйте [развертывание кластера azure обозреватель данных в](https://azure.microsoft.com/resources/templates/101-kusto-vnet/) шаблоне виртуальной сети Azure Resource Manager.

Этот шаблон создает кластер, виртуальную сеть, подсеть, группу безопасности сети и общедоступные IP-адреса.
