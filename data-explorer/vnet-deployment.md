---
title: Развертывание исследователя данных Azure в виртуальную сеть
description: Узнайте, как развернуть Explorer данных Azure в виртуальной сети
author: basaba
ms.author: basaba
ms.reviewer: orspodek
ms.service: data-explorer
ms.topic: conceptual
ms.date: 10/31/2019
ms.openlocfilehash: 170db0d00f42209a2fd55c4009ab2f11eff55641
ms.sourcegitcommit: c4aea69fafa9d9fbb814764eebbb0ae93fa87897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81610198"
---
# <a name="deploy-azure-data-explorer-cluster-into-your-virtual-network"></a>Развертывание кластера Azure Data Explorer в виртуальную сеть

В этой статье разъясняются ресурсы, которые присутствуют при развертывании кластера Azure Data Explorer в пользовательскую виртуальную сеть Azure. Эта информация поможет вам развернуть кластер в подсеть в вашей виртуальной сети (VNet). Для получения дополнительной информации о [What is Azure Virtual Network?](/azure/virtual-network/virtual-networks-overview) виртуальных сетях Azure см.

   ![диаграмма vnet](media/vnet-deployment/vnet-diagram.png)

Azure Data Explorer поддерживает развертывание кластера в подсети в виртуальной сети (VNet). Эта возможность позволяет:

* Соблюдение [сетевой безопасности группы](/azure/virtual-network/security-overview) (NSG) правила на azure Data Explorer кластерного трафика.
* Подключите локтую сеть к подсети кластера Azure Data Explorer.
* Обезоверьте свои источники подключения данных[(Event Hub](/azure/event-hubs/event-hubs-about) и [Event Grid)](/azure/event-grid/overview)с [конечными точками обслуживания.](/azure/virtual-network/virtual-network-service-endpoints-overview)

## <a name="access-your-azure-data-explorer-cluster-in-your-vnet"></a>Доступ к кластеру Azure Data Explorer в VNet

Вы можете получить доступ к кластеру Azure Data Explorer, используя следующие IP-адреса для каждой службы (службы управления движками и данными):

* **Частный IP**: Используется для доступа к кластеру внутри VNet.
* **Общедоступный IP**: Используется для доступа к кластеру из-за пределов VNet для управления и мониторинга, а также в качестве исходного адреса для исходящих соединений, запускаемых из кластера.

Для доступа к службе создаются следующие записи DNS: 

* `[clustername].[geo-region].kusto.windows.net`(двигатель) `ingest-[clustername].[geo-region].kusto.windows.net` (управление данными) отображаются на общедоступном ИС для каждой службы. 

* `private-[clustername].[geo-region].kusto.windows.net`(двигатель) `private-ingest-[clustername].[geo-region].kusto.windows.net` (управление данными) отображаются на частном IP для каждой службы.

## <a name="plan-subnet-size-in-your-vnet"></a>Планируйте размер подсети в VNet

Размер подсети, используемой для размещения кластера Azure Data Explorer, не может быть изменен после развертывания подсети. В VNet Azure Data Explorer использует один частный IP-адрес для каждого VM и два частных IP-адреса для внутренних балансиваторов нагрузки (управление двигателями и данными). Сеть Azure также использует пять IP-адресов для каждой подсети. Azure Data Explorer содержит два ВМ для службы управления данными. Двигатели услуг ИВ обслуживаются на емкость шкалы конфигурации пользователя.

Общее количество IP-адресов:

| Использовать | Число адресов |
| --- | --- |
| Обслуживание двигателя | 1 на экземпляр |
| Служба управления данными | 2 |
| Внутренние подсистемы балансировки нагрузки | 2 |
| Зарезервированные адреса Azure | 5 |
| **Общая** | **#engine_instances No 9** |

> [!IMPORTANT]
> Размер подсети должен планироваться заранее, так как он не может быть изменен после развертывания Azure Data Explorer. Поэтому размер подсети необходим соответственно.

## <a name="service-endpoints-for-connecting-to-azure-data-explorer"></a>Конечные точки обслуживания для подключения к исследователю данных Azure

[Endpoints службы Azure](/azure/virtual-network/virtual-network-service-endpoints-overview) позволяет обеспечить доступ к мультитенантным ресурсам Azure в виртуальной сети.
Развертывание кластера Azure Data Explorer в подсети позволяет настроить соединения данных с [помощью концентратора событий](/azure/event-hubs/event-hubs-about) или [сетки событий,](/azure/event-grid/overview) ограничивая при этом базовые ресурсы подсети Azure Data Explorer.

> [!NOTE]
> При использовании настройки EventGrid с [хранилищем](/azure/storage/common/storage-introduction) и «Концентратором событий» учетная запись хранилища, используемая в подписке, может быть заблокирована конечными точками обслуживания в подсети Azure Data Explorer, позволяя надежным службам платформы Azure в [конфигурации брандмауэра,](/azure/storage/common/storage-network-security)но концентратор событий не может включить конечную точку обслуживания, так как он не поддерживает надежные [службы платформы Azure.](/azure/event-hubs/event-hubs-service-endpoints)

## <a name="dependencies-for-vnet-deployment"></a>Зависимости для развертывания VNet

### <a name="network-security-groups-configuration"></a>Конфигурация групп сетевой безопасности

[Группы сетевой безопасности (NSG)](/azure/virtual-network/security-overview) предоставляют возможность управления доступом к сети в VNet. Доступ к Azure Data Explorer можно с помощью двух конечных точек: HTTP (443) и TDS (1433). Следующие правила NSG должны быть настроены, чтобы обеспечить доступ к этим конечным точкам для управления, мониторинга и правильной работы кластера.

#### <a name="inbound-nsg-configuration"></a>Входящие конфигурации NSG

| **Использовать**   | **От**   | **Кому**   | **протокол**;   |
| --- | --- | --- | --- |
| Управление  |[Адреса управления ADX](#azure-data-explorer-management-ip-addresses)/AzureDataExplorerManagement (ServiceTag) | Подсеть ADX:443  | TCP  |
| Мониторинг работоспособности  | [Адреса мониторинга здоровья ADX](#health-monitoring-addresses)  | Подсеть ADX:443  | TCP  |
| Внутренняя коммуникация ADX  | Подсеть ADX: Все порты  | Подсеть ADX: Все порты  | Все  |
| Разрешить Входящий балансосивер нагрузки Azure (зонд здоровья)  | AzureLoadBalancer  | Подсеть ADX:80,443  | TCP  |

#### <a name="outbound-nsg-configuration"></a>Исходящие конфигурации NSG

| **Использовать**   | **От**   | **Кому**   | **протокол**;   |
| --- | --- | --- | --- |
| Зависимость от службы хранилища Azure  | Подсеть ADX  | Хранение:443  | TCP  |
| Зависимость от озера данных Azure  | Подсеть ADX  | AzureDataLake:443  | TCP  |
| EventHub ingestion и мониторинг сервиса  | Подсеть ADX  | EventHub:443,5671  | TCP  |
| Публикация метрик  | Подсеть ADX  | AzureMonitor:443 | TCP  |
| Загрузка конфигурации Azure Monitor  | Подсеть ADX  | [Адреса конечных точек конфигурации Azure Monitor](#azure-monitor-configuration-endpoint-addresses):443 | TCP  |
| Активный каталог (если это применимо) | Подсеть ADX | AzureActiveDirectory:443 | TCP |
| Центр сертификации | Подсеть ADX | Интернет:80 | TCP |
| Взаимодействие изнутри  | Подсеть ADX  | ADX Subnet: Все порты  | Все  |
| Порты, которые `sql\_request` `http\_request` используются для и плагинов  | Подсеть ADX  | Интернет:Таможенный  | TCP  |

### <a name="relevant-ip-addresses"></a>Соответствующие IP-адреса

#### <a name="azure-data-explorer-management-ip-addresses"></a>IP-адреса управления Azure Data Explorer

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 20.37.26.134 |
| Австралия Сентрал2 | 20.39.99.177 |
| Восточная Австралия | 40.82.217.84 |
| Юго-Восточная часть Австралии | 20.40.161.39 |
| БразилияСаут | 191.233.25.183 |
| Центральная Канада | 40.82.188.208 |
| Восточная Канада | 40.80.255.12 |
| Центральная Индия | 40.81.249.251, 104.211.98.159 |
| Центральная часть США | 40.67.188.68 |
| Центральная часть США (EUAP) | 40.89.56.69 |
| Восточная Азия | 20.189.74.103 |
| Восточная часть США | 52.224.146.56 |
| восточная часть США 2 | 52.232.230.201 |
| Восток US2 EUAP | 52.253.226.110 |
| Центральная Франция | 40.66.57.91 |
| Южная Франция | 40.82.236.24 |
| Восточная Япония | 20.43.89.90 |
| Западная Япония | 40.81.184.86 |
| Республика Корея, центральный регион | 40.82.156.149 |
| Республика Корея, южный регион | 40.80.234.9 |
| Центрально-северная часть США | 40.81.45.254 |
| Северная Европа | 52.142.91.221 |
| Северная часть ЮАР; | 102.133.129.138 |
| Западная часть Африки | 102.133.0.97 |
| Центрально-южная часть США | 20.45.3.60 |
| Юго-Восточная Азия | 40.119.203.252 |
| Южная Индия | 40.81.72.110, 104.211.224.189 |
| южная часть Соединенного Королевства | 40.81.154.254 |
| западная часть Соединенного Королевства | 40.81.122.39 |
| центрально-западная часть США | 52.159.55.120 |
| Западная Европа | 51.145.176.215 |
| Западная Индия | 40.81.88.112, 104.211.160.120 |
| западная часть США | 13.64.38.225 |
| Западная часть США 2 | 40.90.219.23 |

#### <a name="health-monitoring-addresses"></a>Адреса мониторинга здоровья

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 191.239.64.128 |
| Центральная Австралия 2 | 191.239.64.128 |
| Восточная Австралия | 191.239.64.128 |
| Юго-Восточная часть Австралии | 191.239.160.47 |
| Южная Бразилия | 23.98.145.105 |
| Центральная Канада | 168.61.212.201 |
| Восточная Канада | 168.61.212.201 |
| Центральная Индия | 23.99.5.162 |
| Центральная часть США | 168.61.212.201 |
| Центральная часть США (EUAP) | 168.61.212.201 |
| Восточная Азия | 168.63.212.33 |
| Восточная часть США | 137.116.81.189 |
| восточная часть США 2 | 137.116.81.189 |
| Восток США 2 EUAP | 137.116.81.189 |
| Центральная Франция | 23.97.212.5 |
| Южная Франция | 23.97.212.5 |
| Восточная Япония | 138.91.19.129 |
| Западная Япония | 138.91.19.129 |
| Республика Корея, центральный регион | 138.91.19.129 |
| Республика Корея, южный регион | 138.91.19.129 |
| Центрально-северная часть США | 23.96.212.108 |
| Северная Европа | 191.235.212.69 
| Северная часть ЮАР; | 104.211.224.189 |
| Западная часть Африки | 104.211.224.189 |
| Центрально-южная часть США | 23.98.145.105 |
| Южная Индия | 23.99.5.162 |
| Юго-Восточная Азия | 168.63.173.234 |
| южная часть Соединенного Королевства | 23.97.212.5 |
| западная часть Соединенного Королевства | 23.97.212.5 |
| центрально-западная часть США | 168.61.212.201 |
| Западная Европа | 23.97.212.5 |
| Западная Индия | 23.99.5.162 |
| западная часть США | 23.99.5.162 |
| западная часть США 2 | 23.99.5.162, 104.210.32.14 |    

#### <a name="azure-monitor-configuration-endpoint-addresses"></a>Адреса конечных точек конфигурации Azure Monitor

| Регион | Адреса |
| --- | --- |
| Центральная Австралия | 52.148.86.165 |
| Центральная Австралия 2 | 52.148.86.165 |
| Восточная Австралия | 52.148.86.165 |
| Юго-Восточная часть Австралии | 52.148.86.165 |
| Южная Бразилия | 13.68.89.19 |
| Центральная Канада | 13.90.43.231 |
| Восточная Канада | 13.90.43.231 |
| Центральная Индия | 13.71.25.187 |
| Центральная часть США | 52.173.95.68 |
| Центральная часть США (EUAP) | 13.90.43.231 |
| Восточная Азия | 13.75.117.221 |
| Восточная часть США | 13.90.43.231 |
| восточная часть США 2 | 13.68.89.19 |    
| Восток США 2 EUAP | 13.68.89.19 |
| Центральная Франция | 52.174.4.112 |
| Южная Франция | 52.174.4.112 |
| Восточная Япония | 13.75.117.221 |
| Западная Япония | 13.75.117.221 |
| Республика Корея, центральный регион | 13.75.117.221 |
| Республика Корея, южный регион | 13.75.117.221 |
| Центрально-северная часть США | 52.162.240.236 |
| Северная Европа | 52.169.237.246 |
| Северная часть ЮАР; | 13.71.25.187 |
| Западная часть Африки | 13.71.25.187 |
| Саут-Центральный США | 13.84.173.99 |
| Южная Индия | 13.71.25.187 |
| Юго-Восточная Азия | 52.148.86.165 |
| южная часть Соединенного Королевства | 52.174.4.112 |
| западная часть Соединенного Королевства | 52.169.237.246 |
| центрально-западная часть США | 52.161.31.69 |
| Западная Европа | 52.174.4.112 |
| Западная Индия | 13.71.25.187 |
| западная часть США | 40.78.70.148 |
| западная часть США 2 | 52.151.20.103 |

## <a name="expressroute-setup"></a>Установка ExpressRoute

Используйте ExpressRoute для подключения сети помещений к виртуальной сети Azure. Общей установкой является реклама маршрута по умолчанию (0.0.0.0/0) через сессию Протокола пограничного шлюза (BGP). Это заставляет трафик выходит из виртуальной сети, которые будут направлены в помещение сети клиента, которые могут снизить трафик, в результате чего исходящие потоки разорвать. Чтобы преодолеть этот по умолчанию, [пользовательский определенный маршрут (UDR)](/azure/virtual-network/virtual-networks-udr-overview#user-defined) (0.0.0.0/0) может быть настроен и следующим переходом будет *Интернет.* Поскольку UDR имеет приоритет над BGP, трафик будет предназначен для Интернета.

## <a name="securing-outbound-traffic-with-firewall"></a>Защита исходящего трафика брандмауэром

Если вы хотите обеспечить исходящий трафик с помощью [Azure Firewall](/azure/firewall/overview) или любого виртуального устройства для ограничения доменных имен, в брандмауэре должны быть разрешены следующие полностью квалифицированные доменные имена (ФЗДН).

```
prod.warmpath.msftcloudes.com:443
production.diagnostics.monitoring.core.windows.net:443
graph.windows.net:443
*.update.microsoft.com:443
shavamanifestcdnprod1.azureedge.net:443
login.live.com:443
wdcp.microsoft.com:443
login.microsoftonline.com:443
azureprofilerfrontdoor.cloudapp.net:443
*.core.windows.net:443
*.servicebus.windows.net:443
shoebox2.metrics.nsatc.net:443
prod-dsts.dsts.core.windows.net:443
*.identity.azure.net:443
*.vault.azure.net:443
ocsp.msocsp.com:80
*.windowsupdate.com:80
ocsp.digicert.com:80
go.microsoft.com:80
dmd.metaservices.microsoft.com:80
www.msftconnecttest.com:80
crl.microsoft.com:80
www.microsoft.com:80
adl.windows.com:80
crl3.digicert.com:80
```

Кроме того, необходимо определить [таблицу маршрутов](/azure/virtual-network/virtual-networks-udr-overview) в подсети с [адресами управления](#azure-data-explorer-management-ip-addresses) и [адресами мониторинга работоспособности](#health-monitoring-addresses) со следующим хмельным *Интернетом,* чтобы предотвратить проблемы с асимметричными маршрутами.

Например, для **региона Западного США** необходимо определить следующие UdRs:

| Имя | Префикс адреса | Следующий хоп |
| --- | --- | --- |
| ADX_Management | 13.64.38.225/32 | Интернет |
| ADX_Monitoring | 23.99.5.162/32 | Интернет |

## <a name="deploy-azure-data-explorer-cluster-into-your-vnet-using-an-azure-resource-manager-template"></a>Развертывание кластера Azure Data Explorer в VNet с помощью шаблона управления ресурсами Azure

Чтобы развернуть кластер Azure Data Explorer в виртуальной сети, используйте кластер Deploy Azure Data Explorer в шаблоне [Управления ресурсами VNet](https://azure.microsoft.com/resources/templates/101-kusto-vnet/) Azure.

Этот шаблон создает кластер, виртуальную сеть, подсеть, группу сетевой безопасности и общедоступные IP-адреса.
